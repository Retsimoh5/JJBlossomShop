<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî CSV Only</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --ink:#0f172a; --paper:#f8fafc; --sakura:#fdeef4; }
    html,body{ height:100%; background:linear-gradient(180deg,var(--sakura),#fff); }
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .jp{ font-family:'Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .card{ border:1px solid rgb(226 232 240); border-radius:1rem; background:#fff }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; border-radius:1rem; border:1px solid #cbd5e1; background:#fff }
    .btn-ghost{ background:transparent; border-color:transparent; color:#475569 }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .hero{ position:relative; overflow:visible; }
    .hero:before{ content:""; position:absolute; inset:0; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160" fill="none"><path d="M0 80c20-20 60-20 80 0s60 20 80 0v80H0V80z" fill="%23fde2e4"/><path d="M0 64c20-20 60-20 80 0s60 20 80 0v16c-20 20-60 20-80 0s-60-20-80 0V64z" fill="%23fbcfe8" opacity=".5"/></svg>'); opacity:.35; background-size:160px 160px; pointer-events:none }
    .menu-panel{ box-shadow:0 10px 30px rgba(0,0,0,.15); z-index:9999; }
    .toast{ position:fixed; right:12px; bottom:12px; background:#0f172a; color:#fff; padding:.6rem .9rem; border-radius:.75rem; font-size:.9rem; z-index:10050; opacity:.95 }
  </style>
</head>
<body>
  <header class="hero">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-6 relative">
      <div id="headerBanner" class="rounded-2xl overflow-hidden border mb-3 relative z-10">
        <img id="headerImg" src="./Header.jpg" class="w-full h-48 sm:h-56 object-cover" alt="JJBlossoms header" onerror="this.closest('#headerBanner').classList.add('hidden')"/>
      </div>
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 relative z-20">
        <div class="flex items-center gap-3">
          <h1 class="brand text-2xl sm:text-3xl font-extrabold text-slate-900">üå∏ JJBlossoms Shop</h1>
          <!-- Dropdown (click to open, overlays everything) -->
          <nav class="relative menu">
            <button id="pkBtn" class="btn">Pok√©mon For Sale ‚ñæ</button>
            <div class="menu-panel hidden absolute mt-2 w-56 rounded-xl border bg-white p-2 text-slate-800">
              <a href="#pokemon:Yerttty" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Yerttty</a>
              <a href="#pokemon:Jonfiin" class="block px-3 py-2 rounded-lg hover:bg-slate-100">Jonfiin</a>
              <a href="#pokemon:All" class="block px-3 py-2 rounded-lg hover:bg-slate-100">All</a>
            </div>
          </nav>
          <a id="homeBtn" href="#" class="btn">üè† Home</a>
        </div>
        <div>
          <p class="jp text-slate-700 text-sm">„Çà„ÅÜ„Åì„Åù ‚Äî Welcome! Where deals bloom and <span class="font-bold">Mewtwo even shops here</span> ‚ú®</p>
          <p class="text-slate-600 mt-1 text-xs">Creators: <span class="font-semibold">Yerttty</span> & <span class="font-semibold">Jonfiin</span></p>
        </div>
        <div class="flex items-center gap-2">
          <button id="reloadBtn" class="btn">üîÑ Reload data</button>
          <button id="openRequests" class="btn">üíå Requests</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-6" id="view-items">
    <div class="card p-4 relative z-0">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-xs text-slate-500">Search</label>
          <input id="searchInput" class="input" placeholder="Search items, categories‚Ä¶" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Category</label>
          <select id="categorySelect" class="input"></select>
        </div>
        <div class="flex items-center justify-end">
          <button id="resetFilters" class="btn btn-ghost">Reset</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">Data source: <span id="sourceTag">CSV</span></p>
    </div>

    <div class="flex items-center justify-between">
      <div id="count" class="text-sm text-slate-600">0 items</div>
      <div class="text-xs text-slate-500">Buy price = <span class="font-semibold">85%</span> of item price (rounded).</div>
    </div>

    <div id="catalog" class="space-y-6"></div>
  </main>

  <!-- Pok√©mon For Sale view (static placeholder until Firebase connected) -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-4 hidden" id="view-pokemon">
    <div class="flex items-center justify-between">
      <h2 class="brand text-xl">Pok√©mon For Sale</h2>
      <div class="text-xs text-slate-500">Source: <span id="pkSource">Coming soon</span></div>
    </div>
    <div class="rounded-xl border p-4 text-sm text-slate-600">
      Add Pok√©mon via the admin once Firebase is connected.
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="pkGrid"></div>
  </main>

  <!-- Requests modal (CSV-only): simple info modal -->
  <div id="reqModal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-4 z-[10000]">
    <div class="max-w-2xl w-full bg-white rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="brand text-lg">Requests</h3>
        <button id="closeReq" class="btn">‚úñ</button>
      </div>
      <div class="text-sm text-slate-600">Requests will be enabled after Firebase is connected. For now, DM Yerttty or Jonfiin on Discord to request price changes, items, or supplier info.</div>
    </div>
  </div>

  <footer class="py-10 text-center text-slate-500 text-sm">
    <div class="brand">üå∏ JJBlossoms ‚Äî Where Mewtwo shops for deals</div>
  </footer>

  <script>
    // ===== CSV-ONLY BUILD =====
    const BUY_RATE = 0.85;
    const CSV_CANDIDATES = ["shop.csv","jjblossoms_inventory_2025-10-12(1).csv"]; // tries both
    const SPRITE_FILES = ["./1.png","./2.png","./3.png","./4.png","./5.png","./46.png","./76.png","./566.png"];

    let RAW_ITEMS=[], VIEW_ITEMS=[], CATEGORIES=new Set();
    const $=(s)=>document.querySelector(s);
    const fmtInt=(n)=>Number.isFinite(n)?Math.round(n):0;
    const cleanNumber=(v)=> typeof v==='number'? v: (typeof v==='string'? Number(v.replace(/[^0-9.\-]/g,'')): NaN);
    const normalize=(h)=>String(h||'').trim().toLowerCase().replace(/\s+/g,' ');

    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 2000); }

    function findHeaderIdx(headers, wanted, exclude=[]){
      const H=headers.map(normalize), bad=exclude.map(normalize);
      for(const key of wanted){
        const idx = H.findIndex(h=> h===key || h.includes(key));
        if(idx!==-1){ const t=H[idx]; if(bad.some(b=>t.includes(b))) continue; return idx; }
      }
      return -1;
    }
    function detectHeaderMap(headers){
      const H=headers.map(normalize);
      const nameIdx = findHeaderIdx(H, ["name","item name","item","title"]);
      const catIdx  = findHeaderIdx(H, ["category","cat","type","group"]);
      // prefer sell/our price; avoid buy
      const priceIdx= findHeaderIdx(H, ["sell price","our price","price","listed price","amount","sell"], ["buy"]);
      const stockIdx= findHeaderIdx(H, ["stock","qty","quantity","amount in stock"]);
      const notesIdx= findHeaderIdx(H, ["notes","desc","description","note"]);
      return {nameIdx,catIdx,priceIdx,stockIdx,notesIdx};
    }

    function rowsToItems(rows){
      const out=[]; const headers = rows[0]||[]; const map = detectHeaderMap(headers);
      for(let r=1;r<rows.length;r++){
        const row=rows[r]||[];
        const name = String(row[map.nameIdx]||"").trim();
        if(!name) continue; // skip blank
        const category = String(row[map.catIdx]||"").trim();
        const price = cleanNumber(row[map.priceIdx]);
        const stockRaw = row[map.stockIdx];
        const hasStock = !(stockRaw===undefined || stockRaw===null || String(stockRaw).trim()==="");
        const stock = hasStock ? Number(stockRaw) : "";
        const notes = String(row[map.notesIdx]||"").trim();
        const buy = fmtInt((Number(price)||0)*BUY_RATE);
        // unique id per row so duplicates (like many DNA/Frags) never overwrite
        const id = (name+"|"+category+"|"+r).toLowerCase();
        out.push({id,name,category,price:fmtInt(price||0),buy,stock: hasStock && Number.isFinite(stock)?stock:"",notes});
      }
      return out;
    }

    function groupByCategory(items){
      const groups={};
      for(const it of items){ const key=it.category||"Other"; (groups[key] ||= []).push(it); }
      const sortedCats=Object.keys(groups).sort((a,b)=>a.localeCompare(b));
      for(const c of sortedCats){ groups[c].sort((a,b)=>a.name.localeCompare(b.name)); }
      return {groups,sortedCats};
    }

    function refreshCategories(){
      CATEGORIES=new Set(VIEW_ITEMS.map(i=>i.category).filter(Boolean));
      const sel=$('#categorySelect'); const current=sel.value; sel.innerHTML='';
      sel.add(new Option('All','All'));
      [...CATEGORIES].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      if(VIEW_ITEMS.some(i=>!i.category)) sel.add(new Option('Other','Other'));
      sel.value = [...sel.options].some(o=>o.value===current)? current : 'All';
      const priceSel=$('#priceItem'); if(priceSel){ priceSel.innerHTML=''; VIEW_ITEMS.forEach(i=> priceSel.add(new Option(i.name, i.name))); }
    }

    function renderItems(){
      const catalog=$('#catalog'); catalog.innerHTML='';
      const q=$('#searchInput').value.toLowerCase().trim(); const chosen=$('#categorySelect').value; const sym='$';
      let items=VIEW_ITEMS.filter(it=> (chosen==='All'||it.category===chosen||(chosen==='Other'&&!it.category)) && (it.name.toLowerCase().includes(q)||(it.category||'').toLowerCase().includes(q)||(it.notes||'').toLowerCase().includes(q)) );
      $('#count').textContent=`${items.length} item${items.length!==1?'s':''}`; const {groups,sortedCats}=groupByCategory(items);
      for(const cat of sortedCats){ const arr=groups[cat]; const sec=document.createElement('section'); sec.className='space-y-3'; const icon=SPRITE_FILES.length? SPRITE_FILES[sortedCats.indexOf(cat)%SPRITE_FILES.length]:''; sec.innerHTML=`
        <div class="flex items-center justify-between mt-6">
          <h2 class="jp text-xl font-bold flex items-center gap-2">${icon?`<img src="${icon}" class="w-6 h-6" onerror=\"this.remove()\"/>`:''}${cat}</h2>
          <div class="text-xs text-slate-500">${arr.length} item${arr.length!==1?'s':''}</div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>`; const grid=sec.querySelector('div.grid');
        for(const it of arr){ const card=document.createElement('div'); card.className='card p-4 hover:shadow-sm transition-shadow'; card.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold">${it.name}</div>
              ${it.notes?`<div class="text-xs text-slate-500 mt-1">${it.notes}</div>`:''}
            </div>
            ${it.stock!==''?`<span class="px-2 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800">Stock: ${it.stock}</span>`:''}
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <div class="bg-pink-50 rounded-xl p-2"><div class="text-slate-500 text-xs">Our Price</div><div class="font-bold">${sym}${it.price}</div></div>
            <div class="bg-rose-100 rounded-xl p-2"><div class="text-slate-500 text-xs">We Buy For (85%)</div><div class="font-bold">${sym}${it.buy}</div></div>
          </div>`; grid.appendChild(card);} catalog.appendChild(sec); }
    }

    function loadFromWorkbook(wb){
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
      if(!rows.length){ return; }
      VIEW_ITEMS = rowsToItems(rows);
      refreshCategories(); renderItems();
    }

    async function loadCSV(){
      document.querySelector('#sourceTag').textContent='CSV';
      for(const fname of [ ...CSV_CANDIDATES ]){
        try{
          const res = await fetch(fname,{cache:'no-store'});
          if(!res.ok) continue;
          const text = await res.text();
          const wb = XLSX.read(text,{type:'string'});
          loadFromWorkbook(wb);
          toast(`Reloaded from ${fname} ‚úì`);
          return true;
        }catch(e){}
      }
      toast('CSV not found');
      return false;
    }

    // Dropdown toggle (click)
    (()=>{
      const menu=document.querySelector('nav.menu');
      const btn=menu.querySelector('#pkBtn');
      const panel=menu.querySelector('.menu-panel');
      btn.addEventListener('click',(e)=>{ e.stopPropagation(); panel.classList.toggle('hidden'); });
      document.addEventListener('click',()=>panel.classList.add('hidden'));
      window.addEventListener('hashchange',()=>panel.classList.add('hidden'));
    })();

    // Home button
    document.querySelector('#homeBtn').addEventListener('click',(e)=>{ e.preventDefault(); location.hash=''; route(); });

    function route(){
      const h=location.hash;
      if(h.startsWith('#pokemon')){
        document.querySelector('#view-items').classList.add('hidden');
        document.querySelector('#view-pokemon').classList.remove('hidden');
      }else{
        document.querySelector('#view-pokemon').classList.add('hidden');
        document.querySelector('#view-items').classList.remove('hidden');
      }
    }
    window.addEventListener('hashchange', route);

    // Requests modal (CSV-only)
    document.querySelector('#openRequests').addEventListener('click',()=> document.querySelector('#reqModal').classList.remove('hidden'));
    document.querySelector('#closeReq').addEventListener('click',()=> document.querySelector('#reqModal').classList.add('hidden'));
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') document.querySelector('#reqModal').classList.add('hidden'); });

    document.querySelector('#searchInput').addEventListener('input', renderItems);
    document.querySelector('#categorySelect').addEventListener('change', renderItems);
    document.querySelector('#resetFilters').addEventListener('click',()=>{ document.querySelector('#searchInput').value=''; document.querySelector('#categorySelect').value='All'; renderItems(); });
    document.querySelector('#reloadBtn').addEventListener('click', loadCSV);

    // Boot
    route();
    loadCSV();
  </script>
</body>
</html>