<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>🌸 JJBlossoms Shop — Live</title>
  <meta name="theme-color" content="#f1cfe1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --pink:#ffd9e8; --rose:#f7cad0; --ink:#0f172a; }
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .9rem; border-radius:.8rem; border:1px solid #e2e8f0; background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    .wavy{ background:linear-gradient(180deg,#ffeaf2,#ffeaf2 40%,#fff 40%); }
    .menu{ position:relative; z-index:40 } /* keep above search row */
    .menu .panel{ position:absolute; top:3rem; left:0; z-index:50; }
    .item-card{ border:1px solid #f4c2d2; border-radius:.8rem; background:rgba(255,255,255,.85) }
  </style>
</head>
<body class="bg-pink-50">
  <div class="max-w-6xl mx-auto p-3 sm:p-6 space-y-3">
    <div class="rounded-2xl overflow-hidden">
      <img src="Header.jpg" alt="Header" class="w-full object-cover" style="max-height:220px;">
    </div>

    <header class="flex items-center justify-between gap-3 flex-wrap">
      <div class="flex items-center gap-2 brand text-xl">
        <span>🌸</span><div><div class="font-bold">JJBLOSSOMS</div><div class="text-xs text-slate-600">ようこそ — Welcome!</div></div>
      </div>

      <div class="flex items-center gap-2">
        <!-- Pokémon menu (always above everything) -->
        <div class="menu">
          <button id="pkMenuBtn" class="btn">🎐 Pokémon For Sale ▾</button>
          <div id="pkMenu" class="panel hidden bg-white shadow-xl rounded-xl border p-2 w-48">
            <a href="#" data-owner="Yerttty" class="block px-3 py-2 rounded hover:bg-pink-50">Yerttty</a>
            <a href="#" data-owner="Jonfiin" class="block px-3 py-2 rounded hover:bg-pink-50">Jonfiin</a>
          </div>
        </div>
        <a href="./index.html" class="btn">🏠 Home</a>
        <button id="reloadBtn" class="btn">🗘 Reload data</button>
        <button id="requestsBtn" class="btn">📮 Requests</button>
      </div>
    </header>

    <p class="text-sm text-slate-700 brand">
      Intro: We stock all the essentials (and then some), keep prices fair, and we’ll buy your items at <b>85% of our listed price</b> — rounded to whole numbers. Creators: <b>Yerttty</b> & <b>Jonfiin</b>. 🌸
    </p>

    <!-- Filters -->
    <section class="card p-3 sm:p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
        <div class="md:col-span-2"><input id="q" class="w-full rounded-xl border border-slate-300 p-2" placeholder="Search items, categories..."></div>
        <div class="flex gap-2 items-center">
          <select id="cat" class="w-full rounded-xl border border-slate-300 p-2"></select>
          <button id="resetBtn" class="btn">Reset</button>
        </div>
      </div>
      <div class="text-xs text-slate-500 mt-1" id="dataSource">Data source: CSV</div>
    </section>

    <!-- Items list -->
    <div id="list" class="space-y-6"></div>

    <!-- Footer -->
    <footer class="text-center text-xs text-slate-500 py-8">🌸 JJBLOSSOMS — Where Mewtwo shops for deals</footer>
  </div>

  <!-- Requests modal -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-5 w-[min(96vw,680px)]">
      <div class="flex items-center justify-between mb-2">
        <h3 class="brand text-lg">Requests</h3>
        <button id="closeModal" class="btn">✕</button>
      </div>
      <p class="text-sm text-slate-700">Requests will be enabled after Firebase is connected. For now, DM Yerttty or Jonfiin on Discord to request price changes, new items, or supplier info.</p>
    </div>
  </div>

<script>
const BUY_RATE = 0.85;
const LS = 'jjb_admin_cfg_v2'; // same as admin
let items = [], pokemon = [], db = null, refItems = null, refPk = null;

const $ = (s)=>document.querySelector(s);
function groupBy(xs, key){ return xs.reduce((acc,x)=>{ const k=x[key]||'Other'; (acc[k]||(acc[k]=[])).push(x); return acc; },{}); }
function fmt(n){ return '$' + Number(n||0).toFixed(0); }

function loadAdminCfg(){
  try{ const d = JSON.parse(localStorage.getItem(LS)||'{}'); return d && d.cfg ? d : null; }catch{ return null; }
}

async function connectIfPossible(){
  const saved = loadAdminCfg();
  if(!saved || !saved.cfg){ $('#dataSource').textContent='Data source: CSV'; return false; }
  try{
    const app = firebase.apps.length? firebase.app(): firebase.initializeApp(saved.cfg);
    const auth = firebase.auth(); await auth.signInAnonymously();
    db = firebase.database();
    refItems = db.ref('/shops/'+ (saved.shopId || 'jjblossoms') +'/items');
    refPk    = db.ref('/shops/'+ (saved.shopId || 'jjblossoms') +'/pokemon');
    $('#dataSource').textContent='Data source: Firebase (Live)';
    refItems.on('value', s=>{ const v=s.val()||{}; items = Object.values(v); render(); });
    refPk.on('value', s=>{ const v=s.val()||{}; pokemon = Object.values(v); });
    return true;
  }catch(e){ console.warn('Firebase connect failed, falling back to CSV', e); return false; }
}

async function loadCsv(){
  try{
    const r = await fetch('shop.csv', {cache:'no-store'});
    if(!r.ok){ console.warn('shop.csv not found'); items=[]; render(); return; }
    const text = await r.text();
    const wb   = XLSX.read(text,{type:'string'});
    const ws   = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
    if(!rows.length) return;
    // header mapping
    const H = (rows[0]||[]).map(h=>String(h||'').toLowerCase());
    const get = (row, keys)=>{
      const idx = H.findIndex(h=> keys.some(k=> h.includes(k)));
      return idx>-1 ? row[idx] : '';
    };
    items = rows.slice(1).map((r,i)=>{
      const name = String(get(r,['name','item'])).trim(); if(!name) return null;
      const category = String(get(r,['category','cat','group','type'])).trim();
      const price = Number(String(get(r,['sell price','sell_price','our price','price','amount','sell'])).replace(/[^0-9.-]/g,''))||0;
      const stockRaw = get(r,['stock','qty','quantity']); const hasStock = String(stockRaw).trim()!=='';
      const notes = String(get(r,['notes','note','desc'])).trim();
      return { id:(name+'|'+category+'|'+i).toLowerCase(), name, category, price:Math.round(price), buy:Math.round(price*BUY_RATE), stock:hasStock?Number(stockRaw):'', notes };
    }).filter(Boolean);
    render();
  }catch(e){ console.error(e); }
}

function fillFilters(){
  const sel = $('#cat'); const cur = sel.value;
  const cats = [...new Set(items.map(i=>i.category).filter(Boolean))].sort();
  sel.innerHTML = '<option value="All">All</option>' + cats.map(c=>`<option>${c}</option>`).join('');
  if(items.some(i=>!i.category)) sel.innerHTML += '<option>Other</option>';
  sel.value = [...sel.options].some(o=>o.value===cur)? cur : 'All';
}

function render(){
  fillFilters();
  const q = $('#q').value.toLowerCase();
  const cat = $('#cat').value||'All';
  const list = $('#list'); list.innerHTML='';

  const groups = groupBy(items.filter(it=>{
    const okCat = cat==='All' || it.category===cat || (cat==='Other' && !it.category);
    const okQ = (it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q);
    return okCat && okQ;
  }), 'category');

  Object.keys(groups).sort().forEach(catName=>{
    const section = document.createElement('section');
    section.innerHTML = `<h3 class="brand text-lg flex items-center gap-2"><span>🧿</span> ${catName||'Other'}</h3>`;
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-2';
    groups[catName].forEach(it=>{
      const card = document.createElement('div');
      card.className = 'item-card p-3';
      card.innerHTML = `
        <div class="font-semibold">${it.name}</div>
        <div class="text-xs text-slate-500 mt-1">Our Price</div>
        <div class="text-base font-bold">${fmt(it.price)}</div>
        <div class="text-xs text-slate-500 mt-2">We Buy For (85%)</div>
        <div class="text-base font-bold">${fmt(it.buy)}</div>`;
      grid.appendChild(card);
    });
    section.appendChild(grid);
    list.appendChild(section);
  });
}

// UI hooks
$('#q').addEventListener('input', render);
$('#cat').addEventListener('change', render);
$('#resetBtn').addEventListener('click', ()=>{ $('#q').value=''; $('#cat').value='All'; render(); });
$('#reloadBtn').addEventListener('click', ()=>{ connectIfPossible().then(ok=>{ if(!ok) loadCsv(); }); });

// Pokémon menu
const pkBtn = $('#pkMenuBtn'), pkPanel = $('#pkMenu');
pkBtn.addEventListener('click', ()=> pkPanel.classList.toggle('hidden'));
document.addEventListener('click', (e)=>{ if(!pkPanel.contains(e.target) && !pkBtn.contains(e.target)) pkPanel.classList.add('hidden'); });
pkPanel.addEventListener('click', (e)=>{
  const a = e.target.closest('a[data-owner]'); if(!a) return;
  const who = a.getAttribute('data-owner');
  if(!db){ alert('Pokémon list will show after Firebase is connected.'); return; }
  // simple list modal
  const owned = (pokemon||[]).filter(p=>p.owner===who);
  const lines = owned.map(p=> `${p.nickname?`${p.nickname} `:''}${p.species} — Lv.${p.level||'?'}, ${p.nature||'?'} — ${fmt(p.price||0)}`).join('\n') || 'No Pokémon listed yet.';
  alert(`${who}'s Pokémon:\n\n${lines}`);
  pkPanel.classList.add('hidden');
});

// Requests modal (works offline too)
$('#requestsBtn').addEventListener('click', ()=> $('#modal').classList.remove('hidden'));
$('#closeModal').addEventListener('click', ()=> $('#modal').classList.add('hidden'));

// boot
connectIfPossible().then(ok=>{ if(!ok) loadCsv(); });
</script>
</body>
</html>
