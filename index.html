<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî Live</title>
  <meta name="theme-color" content="#f8eaf0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase (compat for easier inline use) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    :root{ --cherry:#ff7aa5; --ink:#0f172a; }
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .card{ border:1px solid #f1d9e3; background:#fff; border-radius:16px; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid #e2d3da; background:#fff; padding:.5rem .8rem; border-radius:.75rem; }
    .tag{ background:#fde7f0; color:#b4235f; padding:.1rem .4rem; border-radius:.5rem; font-size:.75rem; }
    .chip{ border:1px solid #f1d9e3; padding:.15rem .45rem; border-radius:.75rem; font-size:.75rem; white-space:nowrap; }
    .pill{ padding:.15rem .6rem; border-radius:999px; font-size:.75rem; border:1px solid #e6e6e6; }
    .shadow-soft{ box-shadow: 0 6px 22px rgba(40,20,40,.06); }
  </style>
</head>
<body class="bg-[#fdeff4]">
  <div class="max-w-6xl mx-auto px-4 lg:px-2 py-4 space-y-4">
    <!-- Banner -->
    <div class="rounded-2xl overflow-hidden border border-[#f1d9e3] shadow-soft">
      <img src="Header.jpg" alt="JJBlossoms banner" class="w-full h-44 object-cover object-center" onerror="this.style.display='none'">
    </div>

    <!-- Header bar -->
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl brand">üå∏ <span class="font-bold">JJBLOSSOMS</span> <span class="text-sm align-middle">SHOP</span></span>
        <span id="dataSource" class="pill text-slate-700">Data source: <b>CSV</b></span>
      </div>
      <nav class="flex items-center gap-2">
        <div class="relative">
          <button id="pkMenu" class="btn">üß¨ Pok√©mon For Sale ‚ñæ</button>
          <div id="pkDropdown" class="hidden absolute z-50 mt-1 w-48 bg-white border rounded-xl shadow-soft">
            <a href="#pokemon" data-owner="All" class="block px-3 py-2 hover:bg-pink-50">All</a>
            <a href="#pokemon" data-owner="Yerttty" class="block px-3 py-2 hover:bg-pink-50">Yerttty</a>
            <a href="#pokemon" data-owner="Jonfiin" class="block px-3 py-2 hover:bg-pink-50">Jonfiin</a>
          </div>
        </div>
        <a href="./admin.html" class="btn">üõ†Ô∏è Admin</a>
        <button id="reloadBtn" class="btn">üîÑ Reload data</button>
        <button id="reqBtn" class="btn">üì© Requests</button>
      </nav>
    </header>

    <!-- Search / filter -->
    <section class="card p-3 md:p-4">
      <div class="flex flex-wrap gap-2 items-center">
        <input id="q" class="flex-1 min-w-[240px] rounded-xl border border-[#f1d9e3] px-3 py-2" placeholder="Search items, categories...">
        <select id="cat" class="rounded-xl border border-[#f1d9e3] px-3 py-2">
          <option value="All">All</option>
        </select>
        <button id="reset" class="btn">Reset</button>
      </div>
    </section>

    <!-- Items list -->
    <div id="itemsWrap" class="space-y-8"></div>

    <!-- Pok√©mon for sale -->
    <section id="pokemon" class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">üß¨ Pok√©mon For Sale</h2>
        <div class="flex gap-2">
          <select id="pkOwnerFilter" class="rounded-xl border border-[#f1d9e3] px-3 py-2">
            <option>All</option><option>Yerttty</option><option>Jonfiin</option>
          </select>
          <input id="qPk" class="rounded-xl border border-[#f1d9e3] px-3 py-2" placeholder="Search Pok√©mon...">
        </div>
      </div>
      <div id="pkGrid" class="grid md:grid-cols-2 gap-3"></div>
    </section>

    <footer class="text-center text-xs text-slate-500 py-6">üå∏ JJBlossoms ‚Äî where Mewtwo shops for deals</footer>
  </div>

  <!-- Requests modal -->
  <dialog id="reqDialog" class="rounded-2xl p-0 w-[min(560px,95vw)]">
    <div class="p-4 border-b brand text-lg">Requests</div>
    <div class="p-4 text-sm space-y-2">
      <p>Requests will be enabled after Firebase is connected. For now, DM <b>Yerttty</b> or <b>Jonfiin</b> on Discord to request price changes or new items.</p>
    </div>
    <div class="p-3 flex justify-end border-t">
      <form method="dialog"><button class="btn">Close</button></form>
    </div>
  </dialog>

  <script>
    // 1) Pull Firebase config from Admin localStorage if available; fallback to your keys.
    const LS='jjb_admin_cfg_v2';
    let cfg=null, shopId='jjblossoms';
    try{
      const raw=localStorage.getItem(LS);
      if(raw){ const j=JSON.parse(raw); if(j?.cfg) cfg=j.cfg; if(j?.shopId) shopId=j.shopId; }
    }catch{}
    if(!cfg){ cfg={
      apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
      authDomain: "jjblossom-35083.firebaseapp.com",
      databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
      projectId: "jjblossom-35083",
      storageBucket: "jjblossom-35083.firebasestorage.app",
      messagingSenderId: "480122553743",
      appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
      measurementId: "G-GVCG3PTNVP"
    };}

    // 2) Firebase connect
    let db, items=[], pokemon=[];
    async function connect(){
      try{
        const app=firebase.apps.length? firebase.app(): firebase.initializeApp(cfg);
        await firebase.auth().signInAnonymously();
        db=firebase.database();
        document.getElementById('dataSource').innerHTML = 'Data source: <b>Firebase (Live)</b>';
        const refItems=db.ref(`/shops/${shopId}/items`);
        const refPk   =db.ref(`/shops/${shopId}/pokemon`);
        refItems.on('value',snap=>{ const v=snap.val()||{}; items=Object.values(v); renderAll(); });
        refPk.on('value',snap=>{ const v=snap.val()||{}; pokemon=Object.values(v); renderPokemon(); });
      }catch(e){
        console.warn('Firebase connect failed, falling back to CSV-only', e);
        document.getElementById('dataSource').innerHTML = 'Data source: <b>CSV</b>';
      }
    }

    // 3) Category icon map (edit filenames if you want different icons)
    const CATEGORY_ICONS={
      "Armour/Weapons":"1.png",
      "DNA":"76.png",
      "Dungeon Frag":"2510.webp"
    };
    function iconFor(cat){
      const file = CATEGORY_ICONS[cat] || null;
      if(!file) return "";
      return `<img src="${file}" class="w-5 h-5 object-contain" onerror="this.style.display='none'">`;
    }

    // 4) Items render
    const $=sel=>document.querySelector(sel);
    function renderAll(){
      // filters
      const q=($('#q').value||'').toLowerCase();
      const catSel=$('#cat').value||'All';
      // group by category
      const cats=new Map();
      for(const it of items){
        if(catSel!=='All' && it.category!==catSel) continue;
        const hay=[it.name||'', it.category||'', it.notes||''].join(' ').toLowerCase();
        if(q && !hay.includes(q)) continue;
        const key=it.category||'Other';
        if(!cats.has(key)) cats.set(key,[]);
        cats.get(key).push(it);
      }
      // fill cat dropdown
      const sel=$('#cat'); const seen=new Set(['All']);
      for(const it of items){ if(it.category) seen.add(it.category); }
      const cur=sel.value; sel.innerHTML=''; for(const k of [...seen]) sel.add(new Option(k,k)); sel.value = [...seen].includes(cur)?cur:'All';

      // render
      const wrap=$('#itemsWrap'); wrap.innerHTML='';
      for(const [cat,list] of cats){
        list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        const sec=document.createElement('section');
        sec.className='space-y-2';
        sec.innerHTML=`
          <div class="flex items-center gap-2">
            <span class="text-sm">üü£</span>
            <h3 class="brand text-lg flex items-center gap-2">${iconFor(cat)} <span>${cat}</span></h3>
            <span class="text-[11px] text-slate-500 ml-2">${list.length} item${list.length===1?'':'s'}</span>
          </div>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>`;
        const grid=sec.querySelector('div.grid');
        for(const it of list){
          const price = Math.round(Number(it.sellPrice ?? it.price ?? 0));
          const buy   = Math.round(price * 0.85);
          const el=document.createElement('div');
          el.className='card p-3 flex flex-col gap-2 hover:shadow-soft transition-shadow';
          el.innerHTML=`
            <div class="font-medium">${it.name||''}</div>
            <div class="flex items-center gap-2 text-xs">
              <span class="chip">Our Price <b>$${price}</b></span>
              <span class="chip">We Buy For (85%) <b>$${buy}</b></span>
              ${it.stock!=='' && it.stock!=null ? `<span class="chip">Stock <b>${it.stock}</b></span>`:''}
            </div>`;
          grid.appendChild(el);
        }
        wrap.appendChild(sec);
      }
    }

    // 5) Pok√©mon render
    function renderPokemon(){
      const owner=$('#pkOwnerFilter').value;
      const q=($('#qPk').value||'').toLowerCase();
      const grid=$('#pkGrid'); grid.innerHTML='';
      const data=pokemon.filter(p=> (owner==='All'||p.owner===owner) && (
        (p.species||'').toLowerCase().includes(q) || (p.nickname||'').toLowerCase().includes(q) || (p.nature||'').toLowerCase().includes(q) || (p.notes||'').toLowerCase().includes(q)
      ));
      for(const p of data){
        const ivs = p.ivs ? `${p.ivs.hp||0}/${p.ivs.atk||0}/${p.ivs.def||0}/${p.ivs.spa||0}/${p.ivs.spd||0}/${p.ivs.spe||0}` : '';
        const evs = p.evs ? `${p.evs.hp||0}/${p.evs.atk||0}/${p.evs.def||0}/${p.evs.spa||0}/${p.evs.spd||0}/${p.evs.spe||0}` : '';
        const flags=[p.shiny?'‚ú® Shiny':null,p.neutered?'Neutered':null].filter(Boolean).join(' ¬∑ ');
        const card=document.createElement('div');
        card.className='card p-3 flex flex-col gap-2 hover:shadow-soft';
        card.innerHTML=`
          <div class="flex items-center justify-between"><div class="font-semibold">${p.nickname?`${p.nickname} (${p.species})`: (p.species||'')}</div><div class="text-xs text-slate-500">${p.owner||''}</div></div>
          <div class="text-xs flex flex-wrap gap-2">
            <span class="tag">$${Number(p.price||0).toFixed(0)}</span>
            ${p.level? `<span class="pill">Lv ${p.level}</span>`:''}
            ${p.nature? `<span class="pill">${p.nature}</span>`:''}
            ${flags? `<span class="pill">${flags}</span>`:''}
          </div>
          <div class="text-xs text-slate-600 space-y-1">
            ${p.tera? `<div>Tera: ${p.tera}</div>`:''}
            ${p.ball? `<div>Ball: ${p.ball}</div>`:''}
            ${p.held? `<div>Held: ${p.held}</div>`:''}
            ${p.ability? `<div>Ability: ${p.ability}</div>`:''}
            ${p.size? `<div>Size: ${p.size}</div>`:''}
            ${ivs? `<div>IVs ${ivs}</div>`:''}
            ${evs? `<div>EVs ${evs}</div>`:''}
            ${p.moves? `<div>Moves: ${p.moves}</div>`:''}
            ${p.notes? `<div>${p.notes}</div>`:''}
          </div>`;
        grid.appendChild(card);
      }
    }

    // UI hooks
    document.getElementById('pkMenu').addEventListener('click',()=>{
      document.getElementById('pkDropdown').classList.toggle('hidden');
    });
    document.getElementById('pkDropdown').addEventListener('click',(e)=>{
      if(e.target.matches('[data-owner]')){
        document.getElementById('pkDropdown').classList.add('hidden');
        document.getElementById('pkOwnerFilter').value=e.target.getAttribute('data-owner');
        location.hash='#pokemon'; renderPokemon();
      }
    });
    document.getElementById('reqBtn').addEventListener('click',()=> document.getElementById('reqDialog').showModal());
    document.getElementById('reloadBtn').addEventListener('click',()=> location.reload());
    document.getElementById('reset').addEventListener('click',()=>{ $('#q').value=''; $('#cat').value='All'; renderAll(); });
    $('#q').addEventListener('input', renderAll); $('#cat').addEventListener('change', renderAll);
    $('#pkOwnerFilter').addEventListener('change', renderPokemon); $('#qPk').addEventListener('input', renderPokemon);

    connect(); // kick off
  </script>
</body>
</html>
