<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Shop ‚Äî Live</title>
  <meta name="theme-color" content="#fce7f3"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .chip{display:inline-flex;align-items:center;gap:.375rem;padding:.25rem .5rem;border-radius:.75rem;border:1px solid #e5e7eb;background:#fff;font-size:.75rem}
    .card{border:1px solid #fee2e2;background:#fff;border-radius:1rem}
  </style>
</head>
<body class="bg-pink-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex items-center justify-between gap-3">
      <h1 class="brand text-2xl sm:text-3xl">üå∏ JJBlossoms <span class="text-pink-500 text-base align-super">shop</span></h1>
      <div class="flex items-center gap-2">
        <div id="dataSource" class="chip">Data source: CSV</div>
        <a href="https://retsimoh5.github.io/jjblossom/admin.html" class="chip">üîß Admin</a>
        <button id="reloadBtn" class="chip">üîÑ Reload data</button>
        <button id="reqBtn" class="chip">üì© Requests</button>
      </div>
    </header>

    <div class="flex items-center gap-2">
      <input id="q" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Search items, categories...">
      <select id="cat" class="rounded-xl border border-slate-300 px-3 py-2">
        <option value="All">All</option>
      </select>
      <button id="reset" class="chip">Reset</button>
    </div>

    <div id="list" class="space-y-8"></div>

    <dialog id="reqDialog" class="rounded-xl p-0 w-[min(36rem,95vw)]">
      <div class="p-4 border-b brand text-lg">Requests</div>
      <div class="p-4 space-y-2 text-sm">
        <p>Once Firebase is connected, this will let visitors request price changes, new items, or supplier info.</p>
        <p>For now, DM <b>Yerttty</b> or <b>Jonfiin</b> on Discord.</p>
      </div>
      <div class="p-3 border-t text-right">
        <button onclick="document.getElementById('reqDialog').close()" class="chip">Close</button>
      </div>
    </dialog>
  </div>

<script>
const BUY_RATE=0.85, LS='jjb_admin_cfg_v2', SHOP='jjblossoms';
let items=[]; const $=s=>document.querySelector(s);

function groupBy(arr, key){ const m=new Map(); for(const it of arr){ const k=it[key]||'Other'; if(!m.has(k)) m.set(k,[]); m.get(k).push(it);} return m; }
function money(n){ n=Number(n||0); return '$'+Math.round(n).toString(); }

function render(){
  const q=$('#q').value.toLowerCase();
  const cat=$('#cat').value||'All';
  const filtered = items.filter(it=> (cat==='All'||it.category===cat) &&
                     ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)));
  const byCat = groupBy(filtered,'category');
  const list=$('#list'); list.innerHTML='';
  [...byCat.keys()].sort().forEach(catName=>{
    const group=byCat.get(catName);
    const section=document.createElement('section');
    section.innerHTML=`
      <h3 class="brand text-lg mb-2 flex items-center gap-2"><span>üç•</span> ${catName||'Other'} <span class="text-xs text-slate-400 ml-auto">${group.length} items</span></h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>`;
    const grid=section.querySelector('div');
    group.forEach(it=>{
      const card=document.createElement('div');
      card.className='card p-3';
      card.innerHTML=`
        <div class="font-semibold">${it.name}</div>
        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
          <div class="chip justify-center">Our Price <b>${money(it.sellPrice ?? it.price)}</b></div>
          <div class="chip justify-center">We Buy (85%) <b>${money((it.sellPrice ?? it.price)*BUY_RATE)}</b></div>
        </div>`;
      grid.appendChild(card);
    });
    list.appendChild(section);
  });
}

function fillCats(){
  const sel=$('#cat'); const cur=sel.value;
  const set=new Set(items.map(i=>i.category).filter(Boolean));
  sel.innerHTML='<option>All</option>';
  [...set].sort().forEach(c=> sel.add(new Option(c,c)));
  if(items.some(i=>!i.category)) sel.add(new Option('Other','Other'));
  sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All';
}

function setSource(text){ $('#dataSource').textContent='Data source: '+text; }

function getCfg(){ try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); return d?.cfg || null; }catch{return null;} }

async function loadFromFirebase(){
  const cfg=getCfg(); if(!cfg) return false;
  try{
    const app = firebase.apps.length? firebase.app(): firebase.initializeApp(cfg);
    const auth=firebase.auth(); await auth.signInAnonymously();
    const db=firebase.database(); setSource('Firebase (Live)');
    const snap = await db.ref('/shops/'+SHOP+'/items').get();
    const v=snap.val()||{}; items=Object.values(v);
    items.sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
    fillCats(); render(); return true;
  }catch(e){ console.error(e); return false; }
}

async function loadFromCsv(){
  try{
    const res=await fetch('shop.csv',{cache:'no-store'});
    if(!res.ok) throw new Error('shop.csv not found');
    const text=await res.text();
    const wb=XLSX.read(text,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
    const headers=(rows[0]||[]).map(h=>String(h||'').toLowerCase());
    const idxName=headers.findIndex(h=>h.includes('name')||h==='item');
    const idxCat=headers.findIndex(h=>h.includes('cat'));
    const idxPrice=headers.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell'));
    const idxNotes=headers.findIndex(h=>h.includes('notes')||h.includes('desc'));
    items = rows.slice(1).map((r,i)=> ({
      id: (String(r[idxName]||'')+'|'+i).toLowerCase(),
      name: String(r[idxName]||'').trim(),
      category: String(r[idxCat]||'').trim(),
      sellPrice: Number(r[idxPrice]||0),
      notes: String(r[idxNotes]||'').trim()
    })).filter(x=>x.name);
    items.sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
    setSource('CSV');
    fillCats(); render();
  }catch(e){ console.error(e); document.getElementById('list').innerHTML='<div class="text-slate-500">Could not load data.</div>'; }
}

async function boot(){ if(!(await loadFromFirebase())) await loadFromCsv(); }
document.addEventListener('DOMContentLoaded', boot);

document.getElementById('q').addEventListener('input', render);
document.getElementById('cat').addEventListener('change', render);
document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.getElementById('cat').value='All'; render(); });
document.getElementById('reloadBtn').addEventListener('click', boot);
document.getElementById('reqBtn').addEventListener('click', ()=> document.getElementById('reqDialog').showModal());
</script>
</body>
</html>
