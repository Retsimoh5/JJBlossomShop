<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms ‚Äî Admin (LIVE via Firebase)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    .pill{ padding:.15rem .5rem; border-radius:999px; font-size:.75rem }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex items-end justify-between gap-3 flex-wrap">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin (LIVE)</h1>
        <p class="text-slate-600 text-sm">Connected to Firebase Realtime Database. Import from <b>shop.csv</b>, then edit items/stock and add Pok√©mon. DNA/Dungeon Frags are handled correctly.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="btn">üè† Back to site</a>
        <button id="btnClearAll" class="btn">üßπ Clear ALL items</button>
        <button id="btnImport" class="btn">üì• Import items from <b>shop.csv</b></button>
      </div>
    </header>

    <!-- CONFIG -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Config</h2>
        <div class="flex items-center gap-2">
          <span id="statusDot" class="pill bg-slate-200 text-slate-700">Not connected</span>
          <button id="btnSaveCfg" class="btn">üíæ Save config</button>
          <button id="btnSignOut" class="btn">üö™ Sign out</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
        <div>
          <label class="text-xs text-slate-500">Shop ID</label>
          <input id="shopId" class="input" placeholder="jjblossoms" value="jjblossoms"/>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-500">Config JSON (paste your Firebase config object)</label>
          <textarea id="cfgJson" class="input" rows="3" placeholder='{"apiKey":"...","authDomain":"...",...}'></textarea>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">Tip: Enable <b>Authentication ‚Üí Anonymous</b> and create <b>Realtime Database</b>. Basic rule:
      <code>{"rules":{".read":true,"shops":{"$shop":{".write":"auth != null"}}}}</code></p>
    </section>

    <!-- ITEMS -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Items</h2>
        <div class="flex items-center gap-2">
          <input id="qItems" class="input" placeholder="Search items">
          <select id="catItems" class="input"></select>
        </div>
      </div>
      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
            <th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th><th class="p-3">Buy(85%)</th><th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
          </tr></thead>
          <tbody id="rowsItems"></tbody>
        </table>
      </div>
    </section>

    <!-- POKEMON -->
    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Pok√©mon For Sale</h2>
        <div class="flex items-center gap-2">
          <select id="owner" class="input">
            <option>Yerttty</option>
            <option>Jonfiin</option>
          </select>
          <input id="species" class="input" placeholder="Species">
          <input id="level" class="input" placeholder="Level">
          <input id="nature" class="input" placeholder="Nature">
          <input id="price" class="input" placeholder="Price">
          <input id="notes" class="input" placeholder="Notes (IVs/EVs/Size/Neutered/etc)">
          <button id="btnAddPk" class="btn">Ôºã Add / Update Pok√©mon</button>
        </div>
      </div>
      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
            <th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
          </tr></thead>
          <tbody id="rowsPk"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const BUY_RATE=0.85, CSV_FILE='shop.csv';
    let app=null, db=null, auth=null, user=null, shop='jjblossoms';

    // --- UI helpers
    const $=(s)=>document.querySelector(s);
    const normalize=(s)=>String(s||'').trim();
    const money=(n)=>`$${Math.round(Number(n||0))}`;
    const toast=(m)=>{alert(m)};

    // --- Save config & init Firebase
    $('#btnSaveCfg').addEventListener('click', async ()=>{
      try{
        shop = normalize($('#shopId').value)||'jjblossoms';
        const cfgTxt=$('#cfgJson').value.trim();
        const cfg = cfgTxt ? JSON.parse(cfgTxt) : null;
        if(!cfg) return alert('Paste your Firebase config JSON.');
        localStorage.setItem('jj_cfg', cfgTxt);
        localStorage.setItem('jj_shop', shop);
        app = firebase.initializeApp(cfg);
        auth = firebase.auth();
        db   = firebase.database();
        await auth.signInAnonymously();
        user = auth.currentUser;
        $('#statusDot').textContent='Connected';
        $('#statusDot').className='pill bg-green-100 text-green-800';
        loadAll();
      }catch(e){ console.error(e); alert('Config invalid: '+e.message); }
    });

    // Restore saved cfg
    (function(){
      const cfg=localStorage.getItem('jj_cfg'); const sid=localStorage.getItem('jj_shop');
      if(sid) $('#shopId').value=sid;
      if(cfg) $('#cfgJson').value=cfg;
    })();

    $('#btnSignOut').addEventListener('click', async ()=>{ try{ await auth?.signOut(); $('#statusDot').textContent='Signed out'; $('#statusDot').className='pill bg-slate-200 text-slate-700'; }catch{} });

    // ---- CSV parsing (robust headers)
    const cleanNum=(v)=> typeof v==='number'? v: (typeof v==='string'? Number(v.replace(/[^0-9.\-]/g,'')): NaN);
    const lower=(h)=>String(h||'').trim().toLowerCase().replace(/\s+/g,' ');
    function findIdx(headers, wanted, exclude=[]) {
      const H=headers.map(lower), bad=exclude.map(lower);
      for(const key of wanted){ const i=H.findIndex(h=>h===key||h.includes(key)); if(i!==-1){ const t=H[i]; if(bad.some(b=>t.includes(b))) continue; return i; } }
      return -1;
    }
    function mapHeaders(headers){
      const name = findIdx(headers,["name","item name","item","title"]);
      const cat  = findIdx(headers,["category","cat","type","group"]);
      const price= findIdx(headers,["sell price","our price","price","listed price","amount","sell"],["buy"]);
      const stock= findIdx(headers,["stock","qty","quantity","amount in stock"]);
      const notes= findIdx(headers,["notes","desc","description","note"]);
      return {name,cat,price,stock,notes};
    }

    function rowsToItems(rows){
      const out=[]; const map=mapHeaders(rows[0]||[]);
      for(let r=1;r<rows.length;r++){
        const row=rows[r]||[];
        const name=normalize(row[map.name]||''); if(!name) continue;
        const category=normalize(row[map.cat]||'');
        const price=cleanNum(row[map.price]);
        const stockRaw=row[map.stock];
        const hasStock=!(stockRaw===undefined||stockRaw===null||String(stockRaw).trim()==='');
        const stock=hasStock? Number(stockRaw): '';
        const notes=normalize(row[map.notes]||'');
        const buy=Math.round((Number(price)||0)*BUY_RATE);
        const id=(name+'|'+category+'|'+r).toLowerCase(); // unique per row
        out.push({id,name,category,price:Math.round(price||0),buy,stock: hasStock && Number.isFinite(stock)?stock:'',notes});
      }
      return out;
    }

    async function importCSVtoDB(){
      try{
        const res=await fetch(CSV_FILE,{cache:'no-store'}); if(!res.ok) return alert('shop.csv not found.');
        const text=await res.text();
        const wb=XLSX.read(text,{type:'string'}); const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true}); if(!rows.length) return alert('CSV empty');
        const items=rowsToItems(rows);
        const base=`shops/${shop}/items`;
        const updates={}; items.forEach(it=>{ updates[`${base}/${it.id}`]=it; });
        await db.ref().update(updates);
        alert(`Imported ${items.length} items to Firebase ‚úì`);
        loadItems();
      }catch(e){ console.error(e); alert('Import failed: '+e.message); }
    }

    $('#btnImport').addEventListener('click', importCSVtoDB);

    async function clearAll(){
      if(!confirm('Delete ALL items under this shop?')) return;
      await db.ref(`shops/${shop}/items`).remove();
      alert('All items cleared');
      loadItems();
    }
    $('#btnClearAll').addEventListener('click', clearAll);

    // ---- Items UI
    function fillCats(list){
      const sel=$('#catItems'); const cur=sel.value; const set=new Set(list.map(i=>i.category).filter(Boolean));
      sel.innerHTML=''; sel.add(new Option('All','All'));
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      if(list.some(i=>!i.category)) sel.add(new Option('Other','Other'));
      sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All';
    }

    function renderItems(list){
      const q=$('#qItems').value.toLowerCase(); const cat=$('#catItems').value||'All';
      const tb=$('#rowsItems'); tb.innerHTML='';
      const data=list.filter(it=> (cat==='All'||it.category===cat||(cat==='Other'&&!it.category)) && ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)) );
      data.forEach(it=>{
        const tr=document.createElement('tr'); tr.innerHTML=`
          <td class="p-2">${it.name}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2">${money(it.price)}</td>
          <td class="p-2">${money(it.buy)}</td>
          <td class="p-2">
            <button class="btn" data-act="sub" data-id="${it.id}">‚àí</button>
            <span class="mx-2 align-middle">${it.stock===''?'':it.stock}</span>
            <button class="btn" data-act="add" data-id="${it.id}">Ôºã</button>
          </td>
          <td class="p-2"><input class="input" data-act="note" data-id="${it.id}" value="${it.notes||''}"></td>
          <td class="p-2">
            <button class="btn" data-act="del" data-id="${it.id}">Delete</button>
          </td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-act]').forEach(b=> b.addEventListener('click', onItemAction));
      tb.querySelectorAll('input[data-act="note"]').forEach(i=> i.addEventListener('change', onNoteChange));
    }

    async function onItemAction(e){
      const id=e.currentTarget.dataset.id; const act=e.currentTarget.dataset.act;
      const ref=db.ref(`shops/${shop}/items/${id}`);
      const snap=await ref.get(); if(!snap.exists()) return;
      const it=snap.val(); let stock=it.stock===''?0:Number(it.stock)||0;
      if(act==='add') stock++; if(act==='sub') stock=Math.max(0, stock-1); if(act==='del'){ if(!confirm('Delete item?')) return; await ref.remove(); return loadItems();}
      await ref.update({stock}); loadItems();
    }
    async function onNoteChange(e){ const id=e.currentTarget.dataset.id; const notes=e.currentTarget.value; await db.ref(`shops/${shop}/items/${id}`).update({notes}); }

    function onItems(list){ fillCats(list); renderItems(list); }

    // ---- Pok√©mon
    async function addPokemon(){
      const owner=$('#owner').value, species=normalize($('#species').value), level=normalize($('#level').value), nature=normalize($('#nature').value), price=Number($('#price').value)||0, notes=normalize($('#notes').value);
      if(!species) return alert('Enter species');
      const id=(owner+'|'+species+'|'+Date.now()).toLowerCase();
      await db.ref(`shops/${shop}/pokemon/${id}`).set({id,owner,species,level,nature,price:Math.round(price),notes,ts:Date.now()});
      $('#species').value=$('#level').value=$('#nature').value=$('#price').value=$('#notes').value='';
      loadPokemon();
    }
    $('#btnAddPk').addEventListener('click', addPokemon);

    function renderPk(list){
      const tb=$('#rowsPk'); tb.innerHTML='';
      list.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${p.owner}</td><td class="p-2">${p.species}</td><td class="p-2">${p.level||''}</td><td class="p-2">${p.nature||''}</td><td class="p-2">${money(p.price)}</td><td class="p-2">${p.notes||''}</td><td class="p-2"><button class="btn" data-pkdel="${p.id}">Delete</button></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-pkdel]').forEach(b=> b.addEventListener('click', async (e)=>{ const id=e.currentTarget.dataset.pkdel; if(!confirm('Delete Pok√©mon?')) return; await db.ref(`shops/${shop}/pokemon/${id}`).remove(); loadPokemon(); }));
    }

    async function loadItems(){
      const snap=await db.ref(`shops/${shop}/items`).get(); const list=snap.exists()? Object.values(snap.val()) : [];
      list.sort((a,b)=> (a.category||'').localeCompare(b.category||'') || String(a.name||'').localeCompare(String(b.name||'')) );
      onItems(list);
    }
    async function loadPokemon(){
      const snap=await db.ref(`shops/${shop}/pokemon`).get(); const list=snap.exists()? Object.values(snap.val()) : [];
      list.sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||''));
      renderPk(list);
    }
    async function loadAll(){ await Promise.all([loadItems(), loadPokemon()]); }

    $('#qItems').addEventListener('input', ()=>{ loadItems(); });
    $('#catItems').addEventListener('change', ()=>{ loadItems(); });
  </script>
</body>
</html>
