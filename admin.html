<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>üå∏ JJBlossoms Admin ‚Äî CSV Viewer (no Firebase)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    table input{ min-width:5rem }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex items-end justify-between gap-3 flex-wrap">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin (CSV Only)</h1>
        <p class="text-slate-600 text-sm">This page reads <b>shop.csv</b> from your repo and shows <b>every row</b> (DNA & Dungeon Frags included). Use it to verify the CSV before connecting Firebase.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="btn">üè† Back to site</a>
        <button id="importCsv" class="btn">üì• Load items from <b>shop.csv</b></button>
      </div>
    </header>

    <section class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="brand text-xl">Items (from CSV)</h2>
        <div class="flex items-center gap-2">
          <input id="qItems" class="input" placeholder="Search items, categories...">
          <select id="catItems" class="input"></select>
        </div>
      </div>
      <div class="overflow-auto rounded-2xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
            <th class="p-3">#</th><th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th><th class="p-3">Buy(85%)</th><th class="p-3">Stock</th><th class="p-3">Notes</th>
          </tr></thead>
          <tbody id="rowsItems"></tbody>
        </table>
      </div>
      <div class="text-xs text-slate-500">If this page shows everything, the CSV is good. Next step is switching to the Firebase-backed admin to edit items live.</div>
    </section>
  </div>

  <script>
    const BUY_RATE=0.85, CSV_FILE='shop.csv';
    let items=[];
    const $=(s)=>document.querySelector(s);
    const fmtInt=(n)=>Number.isFinite(n)?Math.round(n):0;
    const cleanNumber=(v)=> typeof v==='number'? v: (typeof v==='string'? Number(v.replace(/[^0-9.\-]/g,'')): NaN);
    const normalize=(h)=>String(h||'').trim().toLowerCase().replace(/\s+/g,' ');

    function findHeaderIdx(headers, wanted, exclude=[]){
      const H=headers.map(normalize), bad=exclude.map(normalize);
      for(const key of wanted){
        const idx = H.findIndex(h=> h===key || h.includes(key));
        if(idx!==-1){ const t=H[idx]; if(bad.some(b=>t.includes(b))) continue; return idx; }
      }
      return -1;
    }
    function detectHeaderMap(headers){
      const H=headers.map(normalize);
      const nameIdx = findHeaderIdx(H, ['name','item name','item','title']);
      const catIdx  = findHeaderIdx(H, ['category','cat','type','group']);
      const priceIdx= findHeaderIdx(H, ['sell price','our price','price','listed price','amount','sell'], ['buy']); // prefer sell, avoid buy
      const stockIdx= findHeaderIdx(H, ['stock','qty','quantity','amount in stock']);
      const notesIdx= findHeaderIdx(H, ['notes','desc','description','note']);
      return {nameIdx,catIdx,priceIdx,stockIdx,notesIdx};
    }

    function rowsToItems(rows){
      const out=[]; const headers=rows[0]||[]; const map=detectHeaderMap(headers);
      for(let r=1;r<rows.length;r++){
        const row=rows[r]||[];
        const name=String(row[map.nameIdx]||'').trim(); if(!name) continue;
        const category=String(row[map.catIdx]||'').trim();
        const price=cleanNumber(row[map.priceIdx]);
        const stockRaw=row[map.stockIdx];
        const hasStock=!(stockRaw===undefined||stockRaw===null||String(stockRaw).trim()==='');
        const stock=hasStock? Number(stockRaw): '';
        const notes=String(row[map.notesIdx]||'').trim();
        // unique id per row so duplicates never overwrite when you later push to Firebase
        const id=(name+'|'+category+'|'+r).toLowerCase();
        out.push({id,name,category,price:fmtInt(price||0),buy:fmtInt((Number(price)||0)*BUY_RATE),stock: hasStock && Number.isFinite(stock)?stock:'',notes});
      }
      return out;
    }

    function fillItemCats(){
      const sel=$('#catItems'); const cur=sel.value;
      const set=new Set(items.map(i=>i.category).filter(Boolean));
      sel.innerHTML=''; sel.add(new Option('All','All'));
      [...set].sort((a,b)=>a.localeCompare(b)).forEach(c=> sel.add(new Option(c,c)));
      if(items.some(i=>!i.category)) sel.add(new Option('Other','Other'));
      sel.value=[...sel.options].some(o=>o.value===cur)?cur:'All';
    }

    function renderItems(){
      const q=$('#qItems').value.toLowerCase(); const cat=$('#catItems').value||'All';
      const tb=$('#rowsItems'); tb.innerHTML='';
      const data=items.filter(it=> (cat==='All'||it.category===cat||(cat==='Other'&&!it.category)) && ((it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q)) );
      data.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2 text-slate-500">${idx+1}</td>
          <td class="p-2">${it.name||''}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2">$${Number(it.price||0).toFixed(0)}</td>
          <td class="p-2">$${Number(it.buy||0).toFixed(0)}</td>
          <td class="p-2">${it.stock===''?'':it.stock}</td>
          <td class="p-2">${it.notes||''}</td>`;
        tb.appendChild(tr);
      });
    }

    async function importCsv(){
      try{
        const res=await fetch(CSV_FILE,{cache:'no-store'});
        if(!res.ok) return alert('shop.csv not found in your repo root.');
        const text=await res.text();
        const wb=XLSX.read(text,{type:'string'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        if(!rows.length) return alert('CSV is empty.');
        items=rowsToItems(rows);
        items.sort((a,b)=> (a.category||'').localeCompare(b.category||'') || a.name.localeCompare(b.name));
        fillItemCats(); renderItems();
        alert('Loaded from shop.csv ‚úì');
      }catch(e){ console.error(e); alert('Import failed.'); }
    }

    document.querySelector('#importCsv').addEventListener('click', importCsv);
    document.querySelector('#qItems').addEventListener('input', renderItems);
    document.querySelector('#catItems').addEventListener('change', renderItems);

    // auto-load on open
    importCsv();
  </script>
</body>
</html>
