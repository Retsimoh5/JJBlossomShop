<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>🌸 JJBlossoms — Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{ font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial }
    .input{ width:100%; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1 }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .9rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff }
    table input{ min-width:5rem }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">🌸 JJBlossoms — Admin (LIVE)</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pokémon. DNA/Dungeon Frags are handled correctly.</p>
      </div>
      <a class="btn" href="./index.html">🏠 Back to site</a>
    </header>

    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" placeholder="Shop ID (e.g., jjblossoms)" value="jjblossoms">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here'>
      </div>
      <div class="text-xs text-slate-500">Tip: Enable <b>Authentication → Anonymous</b> and create <b>Realtime Database</b>. Rule: <code>{"rules":{"*.read":true,"shops":{"$shop":{"*.write":"auth != null"}}}}</code></div>
      <div class="flex items-center gap-2">
        <button id="saveCfg" class="btn">💾 Save config</button>
        <button id="reload" class="btn">🔄 Reload</button>
        <button id="signOut" class="btn">🚪 Sign out</button>
        <div class="ml-auto text-sm">Status: <b id="status">Not connected</b></div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <button id="importCsv" class="btn">📥 Import items from <b>shop.csv</b></button>
            <button id="recalc" class="btn">🧮 Recalc buy(85%)</button>
            <button id="clearAll" class="btn">🧹 Clear ALL</button>
          </div>
        </div>
        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input class="input" id="itemName" placeholder="Item name" required>
          <input class="input" id="itemCat" placeholder="Category (e.g., DNA, Dungeon Frag)" required>
          <input class="input" id="itemPrice" type="number" placeholder="Sell price $" required>
          <input class="input" id="itemStock" type="number" placeholder="Stock (optional)">
          <input class="input col-span-2" id="itemNotes" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Item</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th><th class="p-3">Buy(85%)</th><th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pokémon For Sale</h2>
          <div class="flex items-center gap-2">
            <select id="pkOwnerFilter" class="input"><option>All</option><option>Yerttty</option><option>Jonfiin</option></select>
            <input id="qPk" class="input" placeholder="Search Pokémon">
          </div>
        </div>
        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select class="input" id="pkOwner" required><option>Yerttty</option><option>Jonfiin</option></select>
          <input class="input" id="pkNickname" placeholder="Nickname (optional)">
          <input class="input" id="pkSpecies" placeholder="Species" required>
          <input class="input" id="pkLevel" type="number" min="1" placeholder="Level" required>
          <input class="input" id="pkNature" placeholder="Nature">
          <input class="input" id="pkPrice" type="number" min="0" placeholder="Price $" required>
          <input class="input" id="pkTera" placeholder="Tera Type (optional)">
          <input class="input" id="pkBall" placeholder="Caught Ball (optional)">
          <input class="input" id="pkHeld" placeholder="Held Item (optional)">
          <input class="input" id="pkAbility" placeholder="Ability (optional)">
          <input class="input" id="pkSize" placeholder="Size (optional)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">IVs (0–31)</div>
            <input class="input" id="ivHP" type="number" min="0" max="31" placeholder="HP">
            <input class="input" id="ivATK" type="number" min="0" max="31" placeholder="ATK">
            <input class="input" id="ivDEF" type="number" min="0" max="31" placeholder="DEF">
            <input class="input" id="ivSPA" type="number" min="0" max="31" placeholder="SP.ATK">
            <input class="input" id="ivSPD" type="number" min="0" max="31" placeholder="SP.DEF">
            <input class="input" id="ivSPE" type="number" min="0" max="31" placeholder="SPE">
          </div>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <div class="text-xs col-span-6 font-semibold">EVs (0–252 each, optional)</div>
            <input class="input" id="evHP" type="number" min="0" max="252" placeholder="HP">
            <input class="input" id="evATK" type="number" min="0" max="252" placeholder="ATK">
            <input class="input" id="evDEF" type="number" min="0" max="252" placeholder="DEF">
            <input class="input" id="evSPA" type="number" min="0" max="252" placeholder="SP.ATK">
            <input class="input" id="evSPD" type="number" min="0" max="252" placeholder="SP.DEF">
            <input class="input" id="evSPE" type="number" min="0" max="252" placeholder="SPE">
          </div>

          <input class="input col-span-2" id="pkMoves" placeholder="Moves (comma-separated)">
          <textarea class="input col-span-2" id="pkNotes" placeholder="Extra notes (optional)"></textarea>
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Pokémon</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left"><th class="p-3">Owner</th><th class="p-3">Name</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th></tr></thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <p class="text-xs text-slate-500">Changes sync instantly to the public site. Use search/filters to narrow, then edit inline or use +/− buttons.</p>
  </div>

<script>
const BUY=0.85, LS='jjb_admin_cfg_v2';
let app, db, auth, refItems, refPk;
let items=[], pokemon=[];
const $=(s)=>document.querySelector(s);
const now=()=>Date.now();
function saveCfg(){ localStorage.setItem(LS, JSON.stringify({ shopId: document.getElementById('shopId').value.trim(), cfg: tryParse(document.getElementById('cfgJson').value) })); }
function tryParse(s){ try{return JSON.parse(s)}catch{return null} }
function loadCfg(){ try{return JSON.parse(localStorage.getItem(LS)||'{}');}catch{return{}} }
function idify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9)); }

async function connect(){
  const cfg=loadCfg(); const shop=(cfg.shopId||'').trim();
  if(!cfg.cfg||!shop){ document.getElementById('status').textContent='Missing config'; return; }
  try{
    app = firebase.apps.length? firebase.app(): firebase.initializeApp(cfg.cfg);
    auth = firebase.auth(); await auth.signInAnonymously();
    db = firebase.database();
    refItems = db.ref('/shops/'+shop+'/items');
    refPk = db.ref('/shops/'+shop+'/pokemon');
    document.getElementById('status').textContent='Connected';
    refItems.on('value', snap=>{ const v=snap.val()||{}; items=Object.values(v); renderItems(); });
    refPk.on('value', snap=>{ const v=snap.val()||{}; pokemon=Object.values(v); renderPk(); });
  }catch(e){ console.error(e); document.getElementById('status').textContent='Error'; }
}

function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error); }
function removeItem(id){ refItems.child(id).remove().catch(console.error); }
function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:now(),id}).catch(console.error); }
function removePk(id){ refPk.child(id).remove().catch(console.error); }

function renderItems(){
  const tb=document.getElementById('rowsItems'); tb.innerHTML='';
  const list=[...items].sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
  for(const it of list){
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td class="p-2">\${it.name||''}</td>
      <td class="p-2">\${it.category||''}</td>
      <td class="p-2">$\${Number(it.sellPrice??it.price??0).toFixed(0)}</td>
      <td class="p-2">$\${Math.round(Number(it.sellPrice??it.price??0)*BUY)}</td>
      <td class="p-2 flex items-center gap-2"><button class="btn" data-act="dec" data-id="\${it.id}">−</button><input class="input w-24" value="\${it.stock===''?'':it.stock}" data-id="\${it.id}" data-field="stock"><button class="btn" data-act="inc" data-id="\${it.id}">+</button></td>
      <td class="p-2"><input class="input" value="\${it.notes||''}" data-id="\${it.id}" data-field="notes"></td>
      <td class="p-2"><button class="btn" data-act="delItem" data-id="\${it.id}">Delete</button></td>\`;
    tb.appendChild(tr);
  }
}

function renderPk(){
  const tb=document.getElementById('rowsPk'); tb.innerHTML='';
  const list=[...pokemon].sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||''));
  for(const p of list){
    const flags=[p.shiny?'✨ Shiny':null,p.neutered?'Neutered':null].filter(Boolean).join(' · ');
    const title=p.nickname?`\${p.nickname} (\${p.species})`:p.species;
    const extras=[p.tera?`Tera: \${p.tera}`:null,p.ball?`Ball: \${p.ball}`:null,p.held?`Held: \${p.held}`:null,p.ability?`Ability: \${p.ability}`:null,p.size?`Size: \${p.size}`:null].filter(Boolean).join(' · ');
    const notes=[extras, p.moves?`Moves: \${p.moves}`:null, p.notes||null].filter(Boolean).join(' — ');
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td class="p-2">\${p.owner||''}</td>
      <td class="p-2">\${title}\${flags?` — \${flags}`:''}</td>
      <td class="p-2">\${p.level||''}</td>
      <td class="p-2">\${p.nature||''}</td>
      <td class="p-2">$\${Number(p.price||0).toFixed(0)}</td>
      <td class="p-2"><input class="input" value="\${notes}" data-pk-id="\${p.id}" data-field="notes"></td>
      <td class="p-2"><button class="btn" data-act="delPk" data-id="\${p.id}">Delete</button></td>\`;
    tb.appendChild(tr);
  }
}

document.getElementById('addItemForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const name=document.getElementById('itemName').value.trim();
  const category=document.getElementById('itemCat').value.trim();
  const sell=Number(document.getElementById('itemPrice').value||0);
  const stock=document.getElementById('itemStock').value===''? '': Number(document.getElementById('itemStock').value);
  const notes=document.getElementById('itemNotes').value.trim();
  const id=idify(name+'-'+category);
  patchItem(id,{ id, name, category, sellPrice:sell, stock, notes });
  e.target.reset();
});

document.getElementById('addPkForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const owner=document.getElementById('pkOwner').value;
  const nickname=document.getElementById('pkNickname').value.trim();
  const species=document.getElementById('pkSpecies').value.trim();
  const id=idify(owner+'-'+species+'-'+Date.now());
  const level=Number(document.getElementById('pkLevel').value||0);
  const nature=document.getElementById('pkNature').value.trim();
  const price=Number(document.getElementById('pkPrice').value||0);
  const tera=document.getElementById('pkTera').value.trim();
  const ball=document.getElementById('pkBall').value.trim();
  const held=document.getElementById('pkHeld').value.trim();
  const ability=document.getElementById('pkAbility').value.trim();
  const size=document.getElementById('pkSize').value.trim();
  const shiny=document.getElementById('pkShiny').checked;
  const neutered=document.getElementById('pkNeutered').checked;
  const ivs={ hp:Number(document.getElementById('ivHP').value||0), atk:Number(document.getElementById('ivATK').value||0), def:Number(document.getElementById('ivDEF').value||0), spa:Number(document.getElementById('ivSPA').value||0), spd:Number(document.getElementById('ivSPD').value||0), spe:Number(document.getElementById('ivSPE').value||0) };
  const evs={ hp:Number(document.getElementById('evHP').value||0), atk:Number(document.getElementById('evATK').value||0), def:Number(document.getElementById('evDEF').value||0), spa:Number(document.getElementById('evSPA').value||0), spd:Number(document.getElementById('evSPD').value||0), spe:Number(document.getElementById('evSPE').value||0) };
  const moves=document.getElementById('pkMoves').value.trim();
  const notes=document.getElementById('pkNotes').value.trim();
  patchPk(id,{ id, owner, nickname, species, level, nature, price, tera, ball, held, ability, size, shiny, neutered, ivs, evs, moves, notes });
  e.target.reset();
});

document.addEventListener('input', (e)=>{
  const t=e.target;
  if(t.matches('input[data-id]')){ const id=t.getAttribute('data-id'); const field=t.getAttribute('data-field'); let v=t.value; if(field==='stock'){ v=v===''?'':Number(v); } patchItem(id,{[field]:v}); }
  if(t.matches('input[data-pk-id]')){ const id=t.getAttribute('data-pk-id'); const field=t.getAttribute('data-field'); patchPk(id,{[field]:t.value}); }
});
document.addEventListener('click', (e)=>{
  const t=e.target; const id=t.getAttribute('data-id');
  if(t.dataset.act==='inc'){ const it=items.find(x=>x.id===id); patchItem(id,{stock:Number(it?.stock||0)+1}); }
  if(t.dataset.act==='dec'){ const it=items.find(x=>x.id===id); patchItem(id,{stock:Math.max(0,Number(it?.stock||0)-1)}); }
  if(t.dataset.act==='delItem'){ if(confirm('Delete item?')) removeItem(id); }
  if(t.dataset.act==='delPk'){ if(confirm('Delete Pokémon?')) removePk(id); }
});

document.getElementById('importCsv').addEventListener('click', async ()=>{
  if(!db){ alert('Connect first (Save config).'); return; }
  try{
    const res=await fetch('shop.csv',{cache:'no-store'});
    if(!res.ok) return alert('shop.csv not found');
    const txt=await res.text();
    const wb=XLSX.read(txt,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
    if(!rows.length) return alert('CSV empty');
    const headers=rows[0].map(x=>String(x||'').toLowerCase());
    const idxName=headers.findIndex(h=>h.includes('name')||h==='item');
    const idxCat=headers.findIndex(h=>h.includes('cat'));
    const idxPrice=headers.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell'));
    const idxStock=headers.findIndex(h=>h.includes('stock'));
    const idxNotes=headers.findIndex(h=>h.includes('notes')||h.includes('desc'));
    const body=rows.slice(1);
    for(const r of body){
      const name=String(r[idxName]||'').trim(); if(!name) continue;
      const category=String(r[idxCat]||'').trim();
      const sell=Number(r[idxPrice]||0);
      const id=idify(name+'-'+category);
      patchItem(id,{ id, name, category, sellPrice:sell, stock: r[idxStock]===''||r[idxStock]==null?'': Number(r[idxStock]), notes:String(r[idxNotes]||'').trim() });
    }
    alert('Imported from CSV ✓');
  }catch(e){ console.error(e); alert('Import failed'); }
});

document.getElementById('saveCfg').addEventListener('click', ()=>{ saveCfg(); connect(); });
document.getElementById('reload').addEventListener('click', ()=> connect());
document.getElementById('signOut').addEventListener('click', async ()=>{ try{ await auth?.signOut(); document.getElementById('status').textContent='Signed out'; }catch(e){ console.error(e); } });

const cfg=loadCfg();
if(cfg.shopId){ document.getElementById('shopId').value=cfg.shopId; }
if(cfg.cfg){ document.getElementById('cfgJson').value=JSON.stringify(cfg.cfg); }
if(cfg.shopId && cfg.cfg){ connect(); }
</script>
</body>
</html>
