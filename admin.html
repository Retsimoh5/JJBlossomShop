<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üå∏ JJBlossoms ‚Äî Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .input{width:100%;padding:.5rem .75rem;border-radius:.75rem;border:1px solid #cbd5e1}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .9rem;border-radius:.75rem;border:1px solid #cbd5e1;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .card{border:1px solid #e2e8f0;border-radius:1rem;background:#fff}
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-wrap items-end justify-between gap-3">
      <div>
        <h1 class="brand text-2xl sm:text-3xl font-bold">üå∏ JJBlossoms ‚Äî Admin (LIVE)</h1>
        <p class="text-slate-600 text-sm">Connect once below, then edit items/stock and add Pok√©mon. Anonymous sign‚Äëin to Firebase Realtime Database.</p>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn" href="./index.html">üè† Back to site</a>
        <button id="saveCfg" class="btn">üíæ Save config</button>
        <button id="reload" class="btn">üîÑ Reload</button>
        <button id="signOut" class="btn">üö™ Sign out</button>
      </div>
    </header>

    <!-- Config -->
    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-slate-500">Shop ID</label>
          <input id="shopId" class="input" value="jjblossoms" placeholder="jjblossoms" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-500">Config JSON (paste your Firebase config object)</label>
          <textarea id="cfgJson" class="input" rows="3" placeholder='{"apiKey":"‚Ä¶","authDomain":"‚Ä¶","databaseURL":"‚Ä¶",‚Ä¶}'></textarea>
        </div>
      </div>
      <div class="text-sm">Status: <span id="status" class="font-semibold text-slate-700">Not connected</span></div>
      <p class="text-xs text-slate-500">Enable <b>Authentication ‚Üí Anonymous</b> and create a <b>Realtime Database</b>. Rule: <code>{"rules":{".read":true,"shops":{"$shop":{".write":"auth != null"}}}}</code></p>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Items -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <button id="importCsv" class="btn">üì• Import items from <b>shop.csv</b></button>
            <button id="clearAll" class="btn">üßπ Clear ALL</button>
          </div>
        </div>

        <!-- Quick add/update -->
        <form id="addItem" class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <input class="input" id="itName" placeholder="Item name" required>
          <input class="input" id="itCat" placeholder="Category" required>
          <input class="input" id="itPrice" type="number" placeholder="Sell price" required>
          <input class="input" id="itStock" type="number" placeholder="Stock (optional)">
          <div class="flex gap-2">
            <input class="input" id="itNotes" placeholder="Notes (optional)">
            <button class="btn btn-primary" type="submit">‚ûï Add / Update</button>
          </div>
        </form>

        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th><th class="p-3">Buy(85%)</th><th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <!-- Pok√©mon For Sale (simplified) -->
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pok√©mon For Sale</h2>
        </div>
        <form id="addPk" class="grid grid-cols-1 md:grid-cols-3 gap-2">
          <select id="pkOwner" class="input" required>
            <option>Yerttty</option>
            <option>Jonfiin</option>
          </select>
          <input id="pkNickname" class="input" placeholder="Nickname (optional)">
          <input id="pkSpecies" class="input" placeholder="Species" required>
          <input id="pkLevel" class="input" type="number" min="1" placeholder="Level">
          <input id="pkNature" class="input" placeholder="Nature">
          <input id="pkPrice" class="input" type="number" min="0" placeholder="Price" required>
          <input id="pkTera" class="input" placeholder="Tera Type (optional)">
          <input id="pkNotes" class="input md:col-span-2" placeholder="Notes (Held, Ball, Moves, extra)">
          <label class="flex items-center gap-2 text-sm"><input id="pkShiny" type="checkbox"> Shiny</label>
          <label class="flex items-center gap-2 text-sm"><input id="pkNeutered" type="checkbox"> Neutered</label>

          <!-- IVs 0‚Äì31 -->
          <div class="md:col-span-3">
            <div class="text-xs font-semibold mb-1">IVs (0‚Äì31)</div>
            <div class="grid grid-cols-6 gap-2">
              <input id="ivHP"   class="input" type="number" min="0" max="31" placeholder="HP 0‚Äì31">
              <input id="ivATK"  class="input" type="number" min="0" max="31" placeholder="ATK 0‚Äì31">
              <input id="ivDEF"  class="input" type="number" min="0" max="31" placeholder="DEF 0‚Äì31">
              <input id="ivSPA"  class="input" type="number" min="0" max="31" placeholder="SP.ATK 0‚Äì31">
              <input id="ivSPD"  class="input" type="number" min="0" max="31" placeholder="SP.DEF 0‚Äì31">
              <input id="ivSPE"  class="input" type="number" min="0" max="31" placeholder="SPE 0‚Äì31">
            </div>
          </div>

          <!-- EVs 0‚Äì252 -->
          <div class="md:col-span-3">
            <div class="text-xs font-semibold mb-1">EVs (0‚Äì252 each)</div>
            <div class="grid grid-cols-6 gap-2">
              <input id="evHP"   class="input" type="number" min="0" max="252" placeholder="HP 0‚Äì252">
              <input id="evATK"  class="input" type="number" min="0" max="252" placeholder="ATK 0‚Äì252">
              <input id="evDEF"  class="input" type="number" min="0" max="252" placeholder="DEF 0‚Äì252">
              <input id="evSPA"  class="input" type="number" min="0" max="252" placeholder="SP.ATK 0‚Äì252">
              <input id="evSPD"  class="input" type="number" min="0" max="252" placeholder="SP.DEF 0‚Äì252">
              <input id="evSPE"  class="input" type="number" min="0" max="252" placeholder="SPE 0‚Äì252">
            </div>
          </div>

          <button class="btn btn-primary md:col-span-3" type="submit">‚ûï Add / Update Pok√©mon</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0"><tr class="text-left">
              <th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th>
            </tr></thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

    <p class="text-xs text-slate-500">Changes sync instantly. Use inline edits or +/‚àí to adjust stock.</p>
  </div>

  <script>
    // -------- helpers --------
    const BUY=0.85; let app, auth, db; let SHOP='jjblossoms';
    const $=(s)=>document.querySelector(s);
    const jget=(k,def)=>{try{return JSON.parse(localStorage.getItem(k)||'null')??def}catch{return def}};
    const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const money=(n)=>'$'+(Math.round(Number(n||0)));
    const safeKey=(s)=>String(s||'').replace(/[.#$\[\]\/]/g,'_'); // RTDB invalid chars
    const cleanNum=(v)=> typeof v==='number'? v : Number(String(v||'').replace(/[^0-9.\-]/g,''))||0;

    // Prefill config if empty
    document.addEventListener('DOMContentLoaded',()=>{
      const pre={
        apiKey: "AIzaSyAfvM_nSppUkYoRa1Bes2NuE-Bs8vTwcIE",
        authDomain: "jjblossom-35083.firebaseapp.com",
        databaseURL: "https://jjblossom-35083-default-rtdb.firebaseio.com",
        projectId: "jjblossom-35083",
        storageBucket: "jjblossom-35083.firebasestorage.app",
        messagingSenderId: "480122553743",
        appId: "1:480122553743:web:04bf017d5e16f28fd477fa",
        measurementId: "G-GVCG3PTNVP"
      };
      if(!$('#cfgJson').value) $('#cfgJson').value=JSON.stringify(pre);
      const sid=jget('jj_shop'); if(sid) $('#shopId').value=sid;
      const cfg=jget('jj_cfg'); if(cfg) $('#cfgJson').value=JSON.stringify(cfg);
    });

    async function connect(){
      SHOP=$('#shopId').value.trim()||'jjblossoms';
      const cfgText=$('#cfgJson').value.trim();
      let cfg; try{ cfg=JSON.parse(cfgText); }catch{ alert('Config JSON is invalid'); return; }
      jset('jj_shop', SHOP); jset('jj_cfg', cfg);
      if(!window.firebase || !firebase.initializeApp){ alert('Firebase library did not load. Try hard refresh (Ctrl+F5) or disable extensions and reload.'); return; }
      try{
        app=firebase.apps && firebase.apps.length? firebase.app() : firebase.initializeApp(cfg);
      }catch{ app=firebase.app(); }
      try{ auth=firebase.auth(); await auth.signInAnonymously(); }catch(e){ alert('Anonymous sign-in failed. Enable it in Firebase Auth.'); throw e; }
      db=firebase.database();
      $('#status').textContent='Connected';
      await loadAll();
    }

    // Buttons
    document.addEventListener('DOMContentLoaded',()=>{
      const on = (id,fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',fn); };
      on('saveCfg', () => { try{ connect(); }catch(e){ alert('Save config failed: '+e.message); console.error(e);} });
      on('reload',   () => { try{ loadAll(); }catch(e){ alert('Reload failed: '+e.message); console.error(e);} });
      on('signOut',  async ()=>{ try{ await auth?.signOut(); document.getElementById('status').textContent='Signed out'; }catch(e){ alert('Sign out failed: '+e.message); } });
      const importBtn=document.getElementById('importCsv');
      if(importBtn) importBtn.addEventListener('click', importFromCsv);
      const clearBtn=document.getElementById('clearAll');
      if(clearBtn) clearBtn.addEventListener('click', async ()=>{ if(!db){ alert('Connect first (Save config).'); return;} if(!confirm('Delete ALL items?')) return; await db.ref(`shops/${SHOP}/items`).remove(); loadItems(); });
    });

    // -------- items --------
    async function loadItems(){
      const snap=await db.ref(`shops/${SHOP}/items`).get();
      const list=snap.exists()? Object.values(snap.val()) : [];
      list.sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
      renderItems(list);
    }

    function renderItems(list){
      const tb=$('#rowsItems'); tb.innerHTML='';
      for(const it of list){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${it.name}</td>
          <td class="p-2">${it.category||''}</td>
          <td class="p-2"><input class="input w-28" data-f="price" data-id="${it.id}" value="${Math.round(it.price||it.sellPrice||0)}"></td>
          <td class="p-2">${money((it.price??it.sellPrice||0)*BUY)}</td>
          <td class="p-2 flex items-center gap-2"><button class="btn" data-f="dec" data-id="${it.id}">‚àí</button><input class="input w-20" data-f="stock" data-id="${it.id}" value="${it.stock===''?'':it.stock}"><button class="btn" data-f="inc" data-id="${it.id}">+</button></td>
          <td class="p-2"><input class="input" data-f="notes" data-id="${it.id}" value="${it.notes||''}"></td>
          <td class="p-2"><button class="btn" data-f="del" data-id="${it.id}">Delete</button></td>`;
        tb.appendChild(tr);
      }
      tb.querySelectorAll('[data-f]').forEach(el=> el.addEventListener('click', onItemClick));
      tb.querySelectorAll('input[data-f]').forEach(el=> el.addEventListener('change', onItemChange));
    }

    async function onItemClick(e){
      const btn=e.currentTarget; const act=btn.dataset.f; const id=btn.dataset.id; const ref=db.ref(`shops/${SHOP}/items/${id}`);
      if(act==='del'){ if(!confirm('Delete item?')) return; await ref.remove(); return loadItems(); }
      const snap=await ref.get(); if(!snap.exists()) return; let it=snap.val(); let stock=it.stock===''?0:Number(it.stock)||0; if(act==='inc') stock++; if(act==='dec') stock=Math.max(0,stock-1); await ref.update({stock}); loadItems();
    }

    async function onItemChange(e){
      const el=e.currentTarget; const field=el.dataset.f; const id=el.dataset.id; const ref=db.ref(`shops/${SHOP}/items/${id}`);
      let val=el.value; if(field==='price') val=Math.round(Number(val)||0); if(field==='stock') val=val===''?'':Number(val)||0; await ref.update({ [field]: val }); loadItems();
    }

    // Add / update from form
    document.getElementById('addItem').addEventListener('submit', async (e)=>{
      e.preventDefault(); const name=$('#itName').value.trim(); const category=$('#itCat').value.trim(); const price=Math.round(Number($('#itPrice').value)||0); const stockRaw=$('#itStock').value; const stock=String(stockRaw).trim()===''?'':Number(stockRaw)||0; const notes=$('#itNotes').value.trim(); const id=safeKey((name+'|'+category).toLowerCase()); await db.ref(`shops/${SHOP}/items/${id}`).update({id,name,category,price,stock,notes}); e.target.reset(); loadItems();
    });

    // Import from CSV (no XLSX dependency)
    async function importFromCsv(){
      try{
        const res = await fetch('shop.csv',{cache:'no-store'});
        if(!res.ok){ alert('shop.csv not found in the repo root'); return; }
        const text = await res.text();
        const rows = parseCSV(text);
        if(rows.length<=1){ alert('CSV looks empty'); return; }
        const H = rows[0].map(h=>String(h||'').toLowerCase());
        const find=(alts,exclude=[])=>{ for(const a of alts){ let i=H.findIndex(h=>h===a||h.includes(a)); if(i!==-1){ const t=H[i]; if(exclude.some(b=>t.includes(b))) continue; return i; } } return -1; };
        const iName = find(['name','item name','item','title']);
        const iCat  = find(['category','cat','type','group']);
        const iPrice= find(['sell price','sell_price','sellprice','our price','price','listed price','amount','sell'],['buy']);
        const iStock= find(['stock','qty','quantity','amount in stock']);
        const iNotes= find(['notes','desc','description','note']);
        if(iName<0||iCat<0||iPrice<0){ alert('CSV headers missing. Need at least Name, Category, and Price.'); return; }
        const updates={}; let n=0;
        for(let r=1;r<rows.length;r++){
          const row=rows[r]||[]; const name=(row[iName]||'').toString().trim(); if(!name) continue;
          const cat=(row[iCat]||'').toString().trim();
          const price=cleanNum(row[iPrice]);
          const stockRaw=row[iStock]; const stock=(stockRaw===undefined||stockRaw===null||String(stockRaw).trim()==='')?'':Number(stockRaw)||0;
          const notes=(row[iNotes]||'').toString().trim();
          const id=safeKey((name+'|'+cat).toLowerCase());
          updates[`shops/${SHOP}/items/${id}`]={id,name,category:cat,price:Math.round(price||0),stock,notes}; n++;
        }
        if(!db){ alert('Connect first (Save config)'); return; }
        await db.ref().update(updates);
        alert(`Imported ${n} items ‚úì`);
        loadItems();
      }catch(e){ console.error(e); alert('Import failed: '+e.message); }
    }

    // simple CSV parser (handles quoted commas)
    function parseCSV(text){
      const rows=[]; let cur=[], val=''; let inQuotes=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(inQuotes){
          if(c==='"' && n==='"'){ val+='"'; i++; }
          else if(c==='"'){ inQuotes=false; }
          else { val+=c; }
        } else {
          if(c==='"'){ inQuotes=true; }
          else if(c===','){ cur.push(val); val=''; }
          else if(c==='
' || c===''){ if(val!=='' || cur.length){ cur.push(val); rows.push(cur); cur=[]; val=''; } if(c==='' && n==='
') i++; }
          else { val+=c; }
        }
      }
      if(val!=='' || cur.length) { cur.push(val); rows.push(cur); }
      return rows;
    }

    // -------- pokemon --------
    async function loadPk(){ const snap=await db.ref(`shops/${SHOP}/pokemon`).get(); const list=snap.exists()? Object.values(snap.val()) : []; list.sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||'')); renderPk(list); }

    function renderPk(list){ const tb=$('#rowsPk'); tb.innerHTML=''; for(const p of list){ const tr=document.createElement('tr'); const flag=[p.shiny?'‚ú® Shiny':null,p.neutered?'Neutered':null].filter(Boolean).join(' ¬∑ '); tr.innerHTML=`<td class="p-2">${p.owner}</td><td class="p-2">${p.nickname?`${p.nickname} (${p.species})`:p.species}${flag?` ‚Äî ${flag}`:''}</td><td class="p-2">${p.level||''}</td><td class="p-2">${p.nature||''}</td><td class="p-2">${money(p.price)}</td><td class="p-2">${p.notes||''}${p.tera?` ¬∑ Tera: ${p.tera}`:''}</td><td class="p-2"><button class="btn" data-delpk="${p.id}">Delete</button></td>`; tb.appendChild(tr);} tb.querySelectorAll('button[data-delpk]').forEach(b=> b.addEventListener('click', async (e)=>{ const id=e.currentTarget.dataset.delpk; if(!confirm('Delete Pok√©mon?')) return; await db.ref(`shops/${SHOP}/pokemon/${id}`).remove(); loadPk(); })); }

    document.getElementById('addPk').addEventListener('submit', async (e)=>{ 
      e.preventDefault(); 
      const owner=$('#pkOwner').value; 
      const nickname=$('#pkNickname').value.trim(); 
      const species=$('#pkSpecies').value.trim(); if(!species) return alert('Enter species'); 
      const level=Number($('#pkLevel').value||0); 
      const nature=$('#pkNature').value.trim(); 
      const price=Math.round(Number($('#pkPrice').value)||0); 
      const notes=$('#pkNotes').value.trim(); 
      const tera=$('#pkTera').value.trim(); 
      const shiny=$('#pkShiny').checked; 
      const neutered=$('#pkNeutered').checked; 
      const ivs={ hp:Number($('#ivHP').value||0), atk:Number($('#ivATK').value||0), def:Number($('#ivDEF').value||0), spa:Number($('#ivSPA').value||0), spd:Number($('#ivSPD').value||0), spe:Number($('#ivSPE').value||0) };
      const evs={ hp:Number($('#evHP').value||0), atk:Number($('#evATK').value||0), def:Number($('#evDEF').value||0), spa:Number($('#evSPA').value||0), spd:Number($('#evSPD').value||0), spe:Number($('#evSPE').value||0) };
      const id=safeKey((owner+'|'+species+'|'+Date.now()).toLowerCase()); 
      await db.ref(`shops/${SHOP}/pokemon/${id}`).set({id,owner,nickname,species,level,nature,price,notes,tera,shiny,neutered,ivs,evs,ts:Date.now()}); 
      e.target.reset(); 
      loadPk(); 
    });

    // Load on open if config saved
    (async()=>{ const saved=jget('jj_cfg'); if(saved){ await connect(); } })();

    async function loadAll(){ await Promise.all([loadItems(), loadPk()]); }
  </script>
</body>
</html>
