<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>🌸 JJBlossoms — Admin (LIVE)</title>
  <meta name="theme-color" content="#0f172a"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .brand{font-family:'Cinzel','Noto Sans JP',system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .input{width:100%;padding:.5rem .75rem;border-radius:.75rem;border:1px solid #cbd5e1}
    .btn{display:inline-flex;align-items:center;gap:.375rem;padding:.45rem .9rem;border-radius:.75rem;border:1px solid #cbd5e1;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .card{border:1px solid #e2e8f0;border-radius:1rem;background:#fff}
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="brand text-2xl sm:text-3xl">🌸 JJBlossoms — Admin (LIVE)</h1>
      <a href="https://retsimoh5.github.io/jjblossom/" class="btn">🏠 Back to site</a>
    </header>

    <section class="card p-4 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="shopId" class="input" value="jjblossoms" placeholder="Shop ID">
        <input id="cfgJson" class="input md:col-span-2" placeholder='Paste Firebase config JSON here'>
      </div>
      <div class="text-xs text-slate-500">
        Firebase Console → Project settings → General → Your apps → Web → copy the config object.
        Enable <b>Authentication → Anonymous</b> and <b>Realtime Database</b>.
      </div>
      <div class="flex items-center gap-2">
        <button id="saveCfg" class="btn">💾 Save config</button>
        <button id="reload" class="btn">🔄 Reload</button>
        <button id="signOut" class="btn">🚪 Sign out</button>
        <div class="ml-auto text-sm">Status: <b id="status">Not connected</b></div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Items</h2>
          <div class="flex items-center gap-2">
            <button id="importCsv" class="btn">📥 Import from shop.csv</button>
            <button id="clearAll" class="btn">🧹 Clear ALL</button>
          </div>
        </div>
        <form id="addItemForm" class="grid grid-cols-2 gap-3">
          <input id="itemName" class="input" placeholder="Item name" required>
          <input id="itemCat" class="input" placeholder="Category (e.g., DNA, Dungeon Frag)" required>
          <input id="itemPrice" class="input" type="number" placeholder="Sell price ($)" required>
          <input id="itemStock" class="input" type="number" placeholder="Stock (optional)">
          <input id="itemNotes" class="input col-span-2" placeholder="Notes (optional)">
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Item</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left"><th class="p-3">Name</th><th class="p-3">Category</th><th class="p-3">Sell</th><th class="p-3">Buy(85%)</th><th class="p-3">Stock</th><th class="p-3">Notes</th><th class="p-3">Actions</th></tr>
            </thead>
            <tbody id="rowsItems"></tbody>
          </table>
        </div>
      </section>

      <section class="card p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="brand text-xl">Pokémon For Sale</h2>
        </div>
        <form id="addPkForm" class="grid grid-cols-2 gap-3">
          <select id="pkOwner" class="input"><option>Yerttty</option><option>Jonfiin</option></select>
          <input id="pkSpecies" class="input" placeholder="Species" required>
          <input id="pkLevel" class="input" type="number" min="1" placeholder="Level" required>
          <input id="pkNature" class="input" placeholder="Nature">
          <input id="pkPrice" class="input" type="number" min="0" placeholder="Price ($)" required>
          <input id="pkNotes" class="input col-span-2" placeholder="Notes (IVs/EVs/Moves, etc.)">
          <button class="btn btn-primary col-span-2" type="submit">➕ Add / Update Pokémon</button>
        </form>
        <div class="overflow-auto rounded-2xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr class="text-left"><th class="p-3">Owner</th><th class="p-3">Species</th><th class="p-3">Lv.</th><th class="p-3">Nature</th><th class="p-3">Price</th><th class="p-3">Notes</th><th class="p-3">Actions</th></tr>
            </thead>
            <tbody id="rowsPk"></tbody>
          </table>
        </div>
      </section>
    </div>

<script>
const BUY_RATE=0.85, LS='jjb_admin_cfg_v2';
let app, db, auth, refItems, refPk;
let items=[], pokemon=[];

const $ = (s)=>document.querySelector(s);
const money = (n)=>'$'+Math.round(Number(n||0));
function idify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('id-'+Math.random().toString(36).slice(2,9)); }
function saveCfg(){ localStorage.setItem(LS, JSON.stringify({ shopId: $('#shopId').value.trim(), cfg: tryParse($('#cfgJson').value) })); }
function loadCfg(){ try{ return JSON.parse(localStorage.getItem(LS)||'{}'); }catch{return {};} }
function tryParse(s){ try{ return JSON.parse(s); }catch{ return null; } }
function now(){ return Date.now(); }

async function connect(){
  const {shopId, cfg} = loadCfg();
  if(!shopId || !cfg){ document.getElementById('status').textContent='Missing config or Shop ID'; return; }
  try{
    app = firebase.apps.length? firebase.app(): firebase.initializeApp(cfg);
    auth = firebase.auth();
    await auth.signInAnonymously();
    db = firebase.database();
    refItems = db.ref('/shops/'+shopId+'/items');
    refPk    = db.ref('/shops/'+shopId+'/pokemon');
    document.getElementById('status').textContent='Connected ✓';

    refItems.on('value', snap=>{ const v=snap.val()||{}; items=Object.values(v); renderItems(); });
    refPk.on('value',    snap=>{ const v=snap.val()||{}; pokemon=Object.values(v); renderPk();  });
  }catch(e){ console.error(e); document.getElementById('status').textContent='Error connecting'; }
}

function patchItem(id,changes){ const cur=items.find(x=>x.id===id)||{id}; refItems.child(id).set({...cur,...changes,_ts:now(),id}); }
function removeItem(id){ refItems.child(id).remove(); }
function patchPk(id,changes){ const cur=pokemon.find(x=>x.id===id)||{id}; refPk.child(id).set({...cur,...changes,_ts:now(),id}); }
function removePk(id){ refPk.child(id).remove(); }

function renderItems(){
  const tb=document.getElementById('rowsItems'); tb.innerHTML='';
  const data=[...items].sort((a,b)=> (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
  for(const it of data){
    const tr=document.createElement('tr');
    const sell = it.sellPrice ?? it.price ?? 0;
    tr.innerHTML=`
      <td class="p-2">${it.name||''}</td>
      <td class="p-2">${it.category||''}</td>
      <td class="p-2">${money(sell)}</td>
      <td class="p-2">${money(sell*BUY_RATE)}</td>
      <td class="p-2 flex items-center gap-2">
        <button class="btn" data-act="dec" data-id="${it.id}">−</button>
        <input class="input w-20" value="${it.stock===''?'':it.stock}" data-id="${it.id}" data-field="stock">
        <button class="btn" data-act="inc" data-id="${it.id}">+</button>
      </td>
      <td class="p-2"><input class="input" value="${it.notes||''}" data-id="${it.id}" data-field="notes"></td>
      <td class="p-2"><button class="btn" data-act="delItem" data-id="${it.id}">Delete</button></td>`;
    tb.appendChild(tr);
  }
}

function renderPk(){
  const tb=document.getElementById('rowsPk'); tb.innerHTML='';
  const data=[...pokemon].sort((a,b)=> (a.owner||'').localeCompare(b.owner||'') || (a.species||'').localeCompare(b.species||''));
  for(const p of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="p-2">${p.owner||''}</td>
      <td class="p-2">${p.species||''}</td>
      <td class="p-2">${p.level||''}</td>
      <td class="p-2">${p.nature||''}</td>
      <td class="p-2">${money(p.price)}</td>
      <td class="p-2"><input class="input" value="${p.notes||''}" data-pk-id="${p.id}" data-field="notes"></td>
      <td class="p-2"><button class="btn" data-act="delPk" data-id="${p.id}">Delete</button></td>`;
    tb.appendChild(tr);
  }
}

document.getElementById('saveCfg').addEventListener('click', ()=>{ saveCfg(); connect(); });
document.getElementById('reload').addEventListener('click', connect);
document.getElementById('signOut').addEventListener('click', async ()=>{ try{ await auth?.signOut(); document.getElementById('status').textContent='Signed out'; }catch(e){ console.error(e); } });

document.getElementById('addItemForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const name=document.getElementById('itemName').value.trim();
  const category=document.getElementById('itemCat').value.trim();
  const sell=Number(document.getElementById('itemPrice').value||0);
  const stock=document.getElementById('itemStock').value===''? '': Number(document.getElementById('itemStock').value);
  const notes=document.getElementById('itemNotes').value.trim();
  const id=idify(name+'-'+category);
  patchItem(id,{ id, name, category, sellPrice:sell, stock, notes });
  e.target.reset();
});

document.getElementById('addPkForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const owner=document.getElementById('pkOwner').value;
  const species=document.getElementById('pkSpecies').value.trim();
  const level=Number(document.getElementById('pkLevel').value||0);
  const nature=document.getElementById('pkNature').value.trim();
  const price=Number(document.getElementById('pkPrice').value||0);
  const notes=document.getElementById('pkNotes').value.trim();
  const id=idify(owner+'-'+species+'-'+Date.now());
  patchPk(id,{ id, owner, species, level, nature, price, notes });
  e.target.reset();
});

document.addEventListener('input', (e)=>{
  const t=e.target;
  if(t.matches('input[data-id]')){
    const id=t.getAttribute('data-id');
    const field=t.getAttribute('data-field');
    let v=t.value;
    if(field==='stock'){ v = v===''? '': Number(v); }
    patchItem(id, { [field]: v });
  }
  if(t.matches('input[data-pk-id]')){
    const id=t.getAttribute('data-pk-id');
    const field=t.getAttribute('data-field');
    patchPk(id, { [field]: t.value });
  }
});

document.addEventListener('click', (e)=>{
  const t=e.target, act=t.dataset.act, id=t.dataset.id;
  if(act==='inc'){ const it=items.find(x=>x.id===id); patchItem(id,{ stock: Number(it?.stock||0)+1 }); }
  if(act==='dec'){ const it=items.find(x=>x.id===id); patchItem(id,{ stock: Math.max(0, Number(it?.stock||0)-1) }); }
  if(act==='delItem'){ if(confirm('Delete item?')) removeItem(id); }
  if(act==='delPk'){ if(confirm('Delete Pokémon?')) removePk(id); }
});

document.getElementById('importCsv').addEventListener('click', async ()=>{
  if(!db){ alert('Connect first (Save config)'); return; }
  try{
    const res=await fetch('shop.csv',{cache:'no-store'});
    if(!res.ok) return alert('shop.csv not found');
    const txt=await res.text();
    const wb=XLSX.read(txt,{type:'string'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
    if(!rows.length) return alert('CSV empty');
    const headers=(rows[0]||[]).map(h=>String(h||'').toLowerCase());
    const idxName=headers.findIndex(h=>h.includes('name')||h==='item');
    const idxCat=headers.findIndex(h=>h.includes('cat'));
    const idxPrice=headers.findIndex(h=>h.includes('sell_price')||h.includes('sell price')||h==='price'||h.includes('price')||h.includes('sell'));
    const idxStock=headers.findIndex(h=>h.includes('stock'));
    const idxNotes=headers.findIndex(h=>h.includes('notes')||h.includes('desc'));
    for(const r of rows.slice(1)){
      const name=String(r[idxName]||'').trim(); if(!name) continue;
      const category=String(r[idxCat]||'').trim();
      const sell=Number(r[idxPrice]||0);
      const id=idify(name+'-'+category);
      patchItem(id,{
        id, name, category, sellPrice:sell,
        stock: (r[idxStock]===''||r[idxStock]==null)?'':Number(r[idxStock]),
        notes: String(r[idxNotes]||'').trim()
      });
    }
    alert('Imported items from CSV ✓');
  }catch(e){ console.error(e); alert('Import failed'); }
});

document.getElementById('clearAll').addEventListener('click', async ()=>{
  if(!db){ alert('Connect first'); return; }
  if(!confirm('Delete ALL items for this shop?')) return;
  await refItems.remove();
  alert('All items cleared');
});

const saved=loadCfg();
if(saved.cfg){ document.getElementById('cfgJson').value = JSON.stringify(saved.cfg); }
if(saved.shopId){ document.getElementById('shopId').value = saved.shopId; }
if(saved.shopId && saved.cfg){ connect(); }
</script>
</body>
</html>
